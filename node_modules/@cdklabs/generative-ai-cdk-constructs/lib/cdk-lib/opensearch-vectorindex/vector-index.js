"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.OpenSearchIndexCRProvider = exports.VectorIndex = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const path = require("path");
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const oss = require("aws-cdk-lib/aws-opensearchserverless");
const custom_resource_provider_helper_1 = require("../../common/helpers/custom-resource-provider-helper");
const utils_1 = require("../../common/helpers/utils");
/**
 * Deploy a vector index on the collection.
 */
class VectorIndex extends cdk.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        this.indexName = props.indexName;
        this.vectorField = props.vectorField;
        this.vectorDimensions = props.vectorDimensions;
        const crProvider = exports.OpenSearchIndexCRProvider.getProvider(this);
        crProvider.role.addManagedPolicy(props.collection.aossPolicy);
        const manageIndexPolicyName = (0, utils_1.generatePhysicalNameV2)(this, 'ManageIndexPolicy', { maxLength: 32, lower: true });
        const manageIndexPolicy = new oss.CfnAccessPolicy(this, 'ManageIndexPolicy', {
            name: manageIndexPolicyName,
            type: 'data',
            policy: JSON.stringify([
                {
                    Rules: [
                        {
                            Resource: [`index/${props.collection.collectionName}/*`],
                            Permission: [
                                'aoss:DescribeIndex',
                                'aoss:CreateIndex',
                                'aoss:DeleteIndex',
                                'aoss:UpdateIndex',
                            ],
                            ResourceType: 'index',
                        },
                        {
                            Resource: [`collection/${props.collection.collectionName}`],
                            Permission: ['aoss:DescribeCollectionItems'],
                            ResourceType: 'collection',
                        },
                    ],
                    Principal: [crProvider.role.roleArn],
                    Description: '',
                },
            ]),
        });
        const analyzerProps = props.analyzer
            ? {
                CharacterFilters: props.analyzer.characterFilters,
                Tokenizer: props.analyzer.tokenizer,
                TokenFilters: props.analyzer.tokenFilters,
            }
            : undefined;
        const vectorIndex = new cdk.CustomResource(this, 'VectorIndex', {
            serviceToken: crProvider.serviceToken,
            properties: {
                Endpoint: `${props.collection.collectionId}.${cdk.Stack.of(this).region}.aoss.amazonaws.com`,
                IndexName: props.indexName,
                VectorField: props.vectorField,
                Dimensions: props.vectorDimensions,
                MetadataManagement: props.mappings.map((m) => {
                    return {
                        MappingField: m.mappingField,
                        DataType: m.dataType,
                        Filterable: m.filterable,
                    };
                }),
                Analyzer: analyzerProps,
            },
            resourceType: 'Custom::OpenSearchIndex',
        });
        vectorIndex.node.addDependency(manageIndexPolicy);
        vectorIndex.node.addDependency(props.collection);
        vectorIndex.node.addDependency(props.collection.dataAccessPolicy);
    }
}
exports.VectorIndex = VectorIndex;
_a = JSII_RTTI_SYMBOL_1;
VectorIndex[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.opensearch_vectorindex.VectorIndex", version: "0.1.285" };
/**
 * Custom Resource provider for OpenSearch Index operations.
 *
 * @internal This is an internal core function and should not be called directly by Solutions Constructs clients.
 */
exports.OpenSearchIndexCRProvider = (0, custom_resource_provider_helper_1.buildCustomResourceProvider)({
    providerName: 'OpenSearchIndexCRProvider',
    codePath: path.join(__dirname, '../../../lambda/opensearch-serverless-custom-resources'),
    handler: 'custom_resources.on_event',
    runtime: lambda.Runtime.PYTHON_3_12,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVjdG9yLWluZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2Nkay1saWIvb3BlbnNlYXJjaC12ZWN0b3JpbmRleC92ZWN0b3ItaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7R0FXRztBQUNILDZCQUE2QjtBQUM3QixtQ0FBbUM7QUFDbkMsaURBQWlEO0FBQ2pELDREQUE0RDtBQUU1RCwwR0FBbUc7QUFDbkcsc0RBQW9FO0FBb0pwRTs7R0FFRztBQUNILE1BQWEsV0FBWSxTQUFRLEdBQUcsQ0FBQyxRQUFRO0lBYzNDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBdUI7UUFDL0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDakMsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7UUFDL0MsTUFBTSxVQUFVLEdBQUcsaUNBQXlCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9ELFVBQVUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU5RCxNQUFNLHFCQUFxQixHQUFHLElBQUEsOEJBQXNCLEVBQ2xELElBQUksRUFDSixtQkFBbUIsRUFDbkIsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FDL0IsQ0FBQztRQUNGLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUMvQyxJQUFJLEVBQ0osbUJBQW1CLEVBQ25CO1lBQ0UsSUFBSSxFQUFFLHFCQUFxQjtZQUMzQixJQUFJLEVBQUUsTUFBTTtZQUNaLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNyQjtvQkFDRSxLQUFLLEVBQUU7d0JBQ0w7NEJBQ0UsUUFBUSxFQUFFLENBQUMsU0FBUyxLQUFLLENBQUMsVUFBVSxDQUFDLGNBQWMsSUFBSSxDQUFDOzRCQUN4RCxVQUFVLEVBQUU7Z0NBQ1Ysb0JBQW9CO2dDQUNwQixrQkFBa0I7Z0NBQ2xCLGtCQUFrQjtnQ0FDbEIsa0JBQWtCOzZCQUNuQjs0QkFDRCxZQUFZLEVBQUUsT0FBTzt5QkFDdEI7d0JBQ0Q7NEJBQ0UsUUFBUSxFQUFFLENBQUMsY0FBYyxLQUFLLENBQUMsVUFBVSxDQUFDLGNBQWMsRUFBRSxDQUFDOzRCQUMzRCxVQUFVLEVBQUUsQ0FBQyw4QkFBOEIsQ0FBQzs0QkFDNUMsWUFBWSxFQUFFLFlBQVk7eUJBQzNCO3FCQUNGO29CQUNELFNBQVMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO29CQUNwQyxXQUFXLEVBQUUsRUFBRTtpQkFDaEI7YUFDRixDQUFDO1NBQ0gsQ0FDRixDQUFDO1FBRUYsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLFFBQVE7WUFDbEMsQ0FBQyxDQUFDO2dCQUNBLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsZ0JBQWdCO2dCQUNqRCxTQUFTLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTO2dCQUNuQyxZQUFZLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxZQUFZO2FBQzFDO1lBQ0QsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNkLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQzlELFlBQVksRUFBRSxVQUFVLENBQUMsWUFBWTtZQUNyQyxVQUFVLEVBQUU7Z0JBQ1YsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxZQUFZLElBQ3hDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQ3JCLHFCQUFxQjtnQkFDckIsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO2dCQUMxQixXQUFXLEVBQUUsS0FBSyxDQUFDLFdBQVc7Z0JBQzlCLFVBQVUsRUFBRSxLQUFLLENBQUMsZ0JBQWdCO2dCQUNsQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO29CQUMzQyxPQUFPO3dCQUNMLFlBQVksRUFBRSxDQUFDLENBQUMsWUFBWTt3QkFDNUIsUUFBUSxFQUFFLENBQUMsQ0FBQyxRQUFRO3dCQUNwQixVQUFVLEVBQUUsQ0FBQyxDQUFDLFVBQVU7cUJBQ3pCLENBQUM7Z0JBQ0osQ0FBQyxDQUFDO2dCQUNGLFFBQVEsRUFBRSxhQUFhO2FBQ0k7WUFDN0IsWUFBWSxFQUFFLHlCQUF5QjtTQUN4QyxDQUFDLENBQUM7UUFFSCxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2xELFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNqRCxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDcEUsQ0FBQzs7QUEzRkgsa0NBNEZDOzs7QUFFRDs7OztHQUlHO0FBQ1UsUUFBQSx5QkFBeUIsR0FBRyxJQUFBLDZEQUEyQixFQUFDO0lBQ25FLFlBQVksRUFBRSwyQkFBMkI7SUFDekMsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQ2pCLFNBQVMsRUFBRSx3REFBd0QsQ0FBQztJQUN0RSxPQUFPLEVBQUUsMkJBQTJCO0lBQ3BDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7Q0FDcEMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgb3NzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1vcGVuc2VhcmNoc2VydmVybGVzcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IGJ1aWxkQ3VzdG9tUmVzb3VyY2VQcm92aWRlciB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL2N1c3RvbS1yZXNvdXJjZS1wcm92aWRlci1oZWxwZXInO1xuaW1wb3J0IHsgZ2VuZXJhdGVQaHlzaWNhbE5hbWVWMiB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL3V0aWxzJztcbmltcG9ydCB7IFZlY3RvckNvbGxlY3Rpb24gfSBmcm9tICcuLi9vcGVuc2VhcmNoc2VydmVybGVzcyc7XG5pbXBvcnQge1xuICBDaGFyYWN0ZXJGaWx0ZXJUeXBlLFxuICBUb2tlbkZpbHRlclR5cGUsXG4gIFRva2VuaXplclR5cGUsXG59IGZyb20gJy4uL29wZW5zZWFyY2hzZXJ2ZXJsZXNzL2FuYWx5c2lzLXBsdWdpbnMnO1xuXG4vKipcbiAqIE1ldGFkYXRhIGZpZWxkIGRlZmluaXRpb25zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1ldGFkYXRhTWFuYWdlbWVudEZpZWxkUHJvcHMge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGZpZWxkLlxuICAgKi9cbiAgcmVhZG9ubHkgbWFwcGluZ0ZpZWxkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgZGF0YSB0eXBlIG9mIHRoZSBmaWVsZC5cbiAgICovXG4gIHJlYWRvbmx5IGRhdGFUeXBlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSBmaWVsZCBpcyBmaWx0ZXJhYmxlLlxuICAgKi9cbiAgcmVhZG9ubHkgZmlsdGVyYWJsZTogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBNZXRhZGF0YSBmaWVsZCBkZWZpbml0aW9ucyBhcyB0aGUgQVBJIGV4cGVjdHMgdGhlbS5cbiAqXG4gKiBAaW50ZXJuYWwgLSBKU0lJIHJlcXVpcmVzIHRoZSBleHBvcnRlZCBpbnRlcmZhY2UgdG8gaGF2ZSBjYW1lbCBjYW1lbENhc2UgcHJvcGVydGllcyxcbiAqIGJ1dCB0aGUgQVBJIGV4cGVjdCBQYXNjYWxDYXNlIHByb3BlcnRpZXNcbiAqL1xudHlwZSBNZXRhZGF0YU1hbmFnZW1lbnRGaWVsZCA9IHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBmaWVsZC5cbiAgICovXG4gIHJlYWRvbmx5IE1hcHBpbmdGaWVsZDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGRhdGEgdHlwZSBvZiB0aGUgZmllbGQuXG4gICAqL1xuICByZWFkb25seSBEYXRhVHlwZTogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0aGUgZmllbGQgaXMgZmlsdGVyYWJsZS5cbiAgICovXG4gIHJlYWRvbmx5IEZpbHRlcmFibGU6IGJvb2xlYW47XG59O1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBDdXN0b206Ok9wZW5TZWFyY2hJbmRleCBjdXN0b20gcmVzb3VyY2UuXG4gKlxuICogQGludGVybmFsXG4gKi9cbmludGVyZmFjZSBWZWN0b3JJbmRleFJlc291cmNlUHJvcHMge1xuICAvKipcbiAgICogVGhlIE9wZW5TZWFyY2ggRW5kcG9pbnQuXG4gICAqL1xuICByZWFkb25seSBFbmRwb2ludDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGluZGV4LlxuICAgKi9cbiAgcmVhZG9ubHkgSW5kZXhOYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgdmVjdG9yIGZpZWxkLlxuICAgKi9cbiAgcmVhZG9ubHkgVmVjdG9yRmllbGQ6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgZGltZW5zaW9ucyBpbiB0aGUgdmVjdG9yLlxuICAgKi9cbiAgcmVhZG9ubHkgRGltZW5zaW9uczogbnVtYmVyO1xuICAvKipcbiAgICogVGhlIG1ldGFkYXRhIG1hbmFnZW1lbnQgZmllbGRzLlxuICAgKi9cbiAgcmVhZG9ubHkgTWV0YWRhdGFNYW5hZ2VtZW50OiBNZXRhZGF0YU1hbmFnZW1lbnRGaWVsZFtdO1xuICAvKipcbiAgICogVGhlIGFuYWx5emVyIHRvIHVzZS5cbiAgICovXG4gIHJlYWRvbmx5IEFuYWx5emVyPzogQW5hbHl6ZXJQcm9wcztcbn1cblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciB0aGUgQW5hbHl6ZXIgdXNlZCBpbiBDdXN0b206Ok9wZW5TZWFyY2hJbmRleCBjdXN0b20gcmVzb3VyY2UuXG4gKlxuICogQGludGVybmFsIC0gSlNJSSByZXF1aXJlcyB0aGUgZXhwb3J0ZWQgaW50ZXJmYWNlIHRvIGhhdmUgY2FtZWwgY2FtZWxDYXNlIHByb3BlcnRpZXNcbiAqL1xuaW50ZXJmYWNlIEFuYWx5emVyUHJvcHMge1xuICAvKipcbiAgICogVGhlIGFuYWx5emVycyB0byB1c2UuXG4gICAqL1xuICByZWFkb25seSBDaGFyYWN0ZXJGaWx0ZXJzOiBDaGFyYWN0ZXJGaWx0ZXJUeXBlW107XG4gIC8qKlxuICAgKiBUaGUgdG9rZW5pemVyIHRvIHVzZS5cbiAgICovXG4gIHJlYWRvbmx5IFRva2VuaXplcjogVG9rZW5pemVyVHlwZTtcbiAgLyoqXG4gICAqIFRoZSB0b2tlbiBmaWx0ZXJzIHRvIHVzZS5cbiAgICovXG4gIHJlYWRvbmx5IFRva2VuRmlsdGVyczogVG9rZW5GaWx0ZXJUeXBlW107XG59XG5cbi8qKlxuICogUHJvcGVydGllcyBmb3IgdGhlIEFuYWx5emVyLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFuYWx5emVyIHtcbiAgLyoqXG4gICAqIFRoZSBhbmFseXplcnMgdG8gdXNlLlxuICAgKi9cbiAgcmVhZG9ubHkgY2hhcmFjdGVyRmlsdGVyczogQ2hhcmFjdGVyRmlsdGVyVHlwZVtdO1xuICAvKipcbiAgICogVGhlIHRva2VuaXplciB0byB1c2UuXG4gICAqL1xuICByZWFkb25seSB0b2tlbml6ZXI6IFRva2VuaXplclR5cGU7XG4gIC8qKlxuICAgKiBUaGUgdG9rZW4gZmlsdGVycyB0byB1c2UuXG4gICAqL1xuICByZWFkb25seSB0b2tlbkZpbHRlcnM6IFRva2VuRmlsdGVyVHlwZVtdO1xufVxuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBWZWN0b3JJbmRleC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBWZWN0b3JJbmRleFByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBPcGVuU2VhcmNoIFZlY3RvciBDb2xsZWN0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgY29sbGVjdGlvbjogVmVjdG9yQ29sbGVjdGlvbjtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBpbmRleC5cbiAgICovXG4gIHJlYWRvbmx5IGluZGV4TmFtZTogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIHZlY3RvciBmaWVsZC5cbiAgICovXG4gIHJlYWRvbmx5IHZlY3RvckZpZWxkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIGRpbWVuc2lvbnMgaW4gdGhlIHZlY3Rvci5cbiAgICovXG4gIHJlYWRvbmx5IHZlY3RvckRpbWVuc2lvbnM6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBtZXRhZGF0YSBtYW5hZ2VtZW50IGZpZWxkcy5cbiAgICovXG4gIHJlYWRvbmx5IG1hcHBpbmdzOiBNZXRhZGF0YU1hbmFnZW1lbnRGaWVsZFByb3BzW107XG4gIC8qKlxuICAgKiBUaGUgYW5hbHl6ZXIgdG8gdXNlLlxuICAgKiBAZGVmYXVsdCAtIE5vIGFuYWx5emVyLlxuICAgKi9cbiAgcmVhZG9ubHkgYW5hbHl6ZXI/OiBBbmFseXplcjtcbn1cblxuLyoqXG4gKiBEZXBsb3kgYSB2ZWN0b3IgaW5kZXggb24gdGhlIGNvbGxlY3Rpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBWZWN0b3JJbmRleCBleHRlbmRzIGNkay5SZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgaW5kZXguXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaW5kZXhOYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgdmVjdG9yIGZpZWxkLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHZlY3RvckZpZWxkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIGRpbWVuc2lvbnMgaW4gdGhlIHZlY3Rvci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB2ZWN0b3JEaW1lbnNpb25zOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFZlY3RvckluZGV4UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5pbmRleE5hbWUgPSBwcm9wcy5pbmRleE5hbWU7XG4gICAgdGhpcy52ZWN0b3JGaWVsZCA9IHByb3BzLnZlY3RvckZpZWxkO1xuICAgIHRoaXMudmVjdG9yRGltZW5zaW9ucyA9IHByb3BzLnZlY3RvckRpbWVuc2lvbnM7XG4gICAgY29uc3QgY3JQcm92aWRlciA9IE9wZW5TZWFyY2hJbmRleENSUHJvdmlkZXIuZ2V0UHJvdmlkZXIodGhpcyk7XG4gICAgY3JQcm92aWRlci5yb2xlLmFkZE1hbmFnZWRQb2xpY3kocHJvcHMuY29sbGVjdGlvbi5hb3NzUG9saWN5KTtcblxuICAgIGNvbnN0IG1hbmFnZUluZGV4UG9saWN5TmFtZSA9IGdlbmVyYXRlUGh5c2ljYWxOYW1lVjIoXG4gICAgICB0aGlzLFxuICAgICAgJ01hbmFnZUluZGV4UG9saWN5JyxcbiAgICAgIHsgbWF4TGVuZ3RoOiAzMiwgbG93ZXI6IHRydWUgfSxcbiAgICApO1xuICAgIGNvbnN0IG1hbmFnZUluZGV4UG9saWN5ID0gbmV3IG9zcy5DZm5BY2Nlc3NQb2xpY3koXG4gICAgICB0aGlzLFxuICAgICAgJ01hbmFnZUluZGV4UG9saWN5JyxcbiAgICAgIHtcbiAgICAgICAgbmFtZTogbWFuYWdlSW5kZXhQb2xpY3lOYW1lLFxuICAgICAgICB0eXBlOiAnZGF0YScsXG4gICAgICAgIHBvbGljeTogSlNPTi5zdHJpbmdpZnkoW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIFJ1bGVzOiBbXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBSZXNvdXJjZTogW2BpbmRleC8ke3Byb3BzLmNvbGxlY3Rpb24uY29sbGVjdGlvbk5hbWV9LypgXSxcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uOiBbXG4gICAgICAgICAgICAgICAgICAnYW9zczpEZXNjcmliZUluZGV4JyxcbiAgICAgICAgICAgICAgICAgICdhb3NzOkNyZWF0ZUluZGV4JyxcbiAgICAgICAgICAgICAgICAgICdhb3NzOkRlbGV0ZUluZGV4JyxcbiAgICAgICAgICAgICAgICAgICdhb3NzOlVwZGF0ZUluZGV4JyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIFJlc291cmNlVHlwZTogJ2luZGV4JyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFJlc291cmNlOiBbYGNvbGxlY3Rpb24vJHtwcm9wcy5jb2xsZWN0aW9uLmNvbGxlY3Rpb25OYW1lfWBdLFxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb246IFsnYW9zczpEZXNjcmliZUNvbGxlY3Rpb25JdGVtcyddLFxuICAgICAgICAgICAgICAgIFJlc291cmNlVHlwZTogJ2NvbGxlY3Rpb24nLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIFByaW5jaXBhbDogW2NyUHJvdmlkZXIucm9sZS5yb2xlQXJuXSxcbiAgICAgICAgICAgIERlc2NyaXB0aW9uOiAnJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdKSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbnN0IGFuYWx5emVyUHJvcHMgPSBwcm9wcy5hbmFseXplclxuICAgICAgPyB7XG4gICAgICAgIENoYXJhY3RlckZpbHRlcnM6IHByb3BzLmFuYWx5emVyLmNoYXJhY3RlckZpbHRlcnMsXG4gICAgICAgIFRva2VuaXplcjogcHJvcHMuYW5hbHl6ZXIudG9rZW5pemVyLFxuICAgICAgICBUb2tlbkZpbHRlcnM6IHByb3BzLmFuYWx5emVyLnRva2VuRmlsdGVycyxcbiAgICAgIH1cbiAgICAgIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IHZlY3RvckluZGV4ID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCAnVmVjdG9ySW5kZXgnLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGNyUHJvdmlkZXIuc2VydmljZVRva2VuLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBFbmRwb2ludDogYCR7cHJvcHMuY29sbGVjdGlvbi5jb2xsZWN0aW9uSWR9LiR7XG4gICAgICAgICAgY2RrLlN0YWNrLm9mKHRoaXMpLnJlZ2lvblxuICAgICAgICB9LmFvc3MuYW1hem9uYXdzLmNvbWAsXG4gICAgICAgIEluZGV4TmFtZTogcHJvcHMuaW5kZXhOYW1lLFxuICAgICAgICBWZWN0b3JGaWVsZDogcHJvcHMudmVjdG9yRmllbGQsXG4gICAgICAgIERpbWVuc2lvbnM6IHByb3BzLnZlY3RvckRpbWVuc2lvbnMsXG4gICAgICAgIE1ldGFkYXRhTWFuYWdlbWVudDogcHJvcHMubWFwcGluZ3MubWFwKChtKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIE1hcHBpbmdGaWVsZDogbS5tYXBwaW5nRmllbGQsXG4gICAgICAgICAgICBEYXRhVHlwZTogbS5kYXRhVHlwZSxcbiAgICAgICAgICAgIEZpbHRlcmFibGU6IG0uZmlsdGVyYWJsZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KSxcbiAgICAgICAgQW5hbHl6ZXI6IGFuYWx5emVyUHJvcHMsXG4gICAgICB9IGFzIFZlY3RvckluZGV4UmVzb3VyY2VQcm9wcyxcbiAgICAgIHJlc291cmNlVHlwZTogJ0N1c3RvbTo6T3BlblNlYXJjaEluZGV4JyxcbiAgICB9KTtcblxuICAgIHZlY3RvckluZGV4Lm5vZGUuYWRkRGVwZW5kZW5jeShtYW5hZ2VJbmRleFBvbGljeSk7XG4gICAgdmVjdG9ySW5kZXgubm9kZS5hZGREZXBlbmRlbmN5KHByb3BzLmNvbGxlY3Rpb24pO1xuICAgIHZlY3RvckluZGV4Lm5vZGUuYWRkRGVwZW5kZW5jeShwcm9wcy5jb2xsZWN0aW9uLmRhdGFBY2Nlc3NQb2xpY3kpO1xuICB9XG59XG5cbi8qKlxuICogQ3VzdG9tIFJlc291cmNlIHByb3ZpZGVyIGZvciBPcGVuU2VhcmNoIEluZGV4IG9wZXJhdGlvbnMuXG4gKlxuICogQGludGVybmFsIFRoaXMgaXMgYW4gaW50ZXJuYWwgY29yZSBmdW5jdGlvbiBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkgYnkgU29sdXRpb25zIENvbnN0cnVjdHMgY2xpZW50cy5cbiAqL1xuZXhwb3J0IGNvbnN0IE9wZW5TZWFyY2hJbmRleENSUHJvdmlkZXIgPSBidWlsZEN1c3RvbVJlc291cmNlUHJvdmlkZXIoe1xuICBwcm92aWRlck5hbWU6ICdPcGVuU2VhcmNoSW5kZXhDUlByb3ZpZGVyJyxcbiAgY29kZVBhdGg6IHBhdGguam9pbihcbiAgICBfX2Rpcm5hbWUsICcuLi8uLi8uLi9sYW1iZGEvb3BlbnNlYXJjaC1zZXJ2ZXJsZXNzLWN1c3RvbS1yZXNvdXJjZXMnKSxcbiAgaGFuZGxlcjogJ2N1c3RvbV9yZXNvdXJjZXMub25fZXZlbnQnLFxuICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM18xMixcbn0pO1xuIl19