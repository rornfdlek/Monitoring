"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmazonAuroraVectorStore = exports.ExistingAmazonAuroraVectorStore = exports.SupportedPostgreSQLVersions = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const path = require("path");
const cdk = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const iam = require("aws-cdk-lib/aws-iam");
const rds = require("aws-cdk-lib/aws-rds");
const cdk_nag_1 = require("cdk-nag");
const constructs_1 = require("constructs");
const custom_resource_provider_helper_1 = require("../../common/helpers/custom-resource-provider-helper");
const utils_1 = require("../../common/helpers/utils");
const vpc_helper_1 = require("../../common/helpers/vpc-helper");
/**
 * List of supported versions of PostgreSQL for Aurora cluster.
 */
exports.SupportedPostgreSQLVersions = {
    AURORA_POSTGRESQL_V12_16: rds.AuroraPostgresEngineVersion.VER_12_16,
    AURORA_POSTGRESQL_V13_12: rds.AuroraPostgresEngineVersion.VER_13_12,
    AURORA_POSTGRESQL_V14_9: rds.AuroraPostgresEngineVersion.VER_14_9,
    AURORA_POSTGRESQL_V15_4: rds.AuroraPostgresEngineVersion.VER_15_4,
    AURORA_POSTGRESQL_V15_5: rds.AuroraPostgresEngineVersion.VER_15_5,
};
/**
 * Base class for Amazon Aurora Vector Store.
 * Handles both the creation of a new Aurora Vector Store or the usage of an existing Aurora Vector Store.
 */
class BaseAmazonAuroraVectorStore extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        /**
        * Setup databaseName based on if it is provided in the props or not
        * and based on whether it is an existing Aurora Vector Store or not.
        */
        this.databaseName = 'clusterIdentifier' in props ?
            props.databaseName : props.databaseName ?? 'bedrock_vector_db';
        this.schemaName = props.schemaName ?? 'bedrock_integration';
        this.vectorField = props.vectorField ?? 'embedding';
        this.textField = props.textField ?? 'chunks';
        this.metadataField = props.metadataField ?? 'metadata';
        this.tableName = props.tableName ?? 'bedrock_kb';
        this.primaryKeyField = props.primaryKeyField ?? 'id';
        this.embeddingsModelVectorDimension = props.embeddingsModelVectorDimension;
    }
    createAuroraPgCRPolicy(clusterIdentifier) {
        const crPolicy = new iam.ManagedPolicy(this, 'AuroraPgPolicy', {
            managedPolicyName: (0, utils_1.generatePhysicalNameV2)(this, 'AuroraPgPolicy', {
                maxLength: 32,
                lower: true,
            }),
            statements: [
                new iam.PolicyStatement({
                    actions: [
                        'ec2:DescribeInstances',
                        'ec2:CreateNetworkInterface',
                        'ec2:AttachNetworkInterface',
                        'ec2:DescribeNetworkInterfaces',
                        'autoscaling:CompleteLifecycleAction',
                        'ec2:DeleteNetworkInterface',
                    ],
                    resources: ['*'],
                }),
                new iam.PolicyStatement({
                    actions: ['rds:DescribeDBClusters'],
                    resources: [
                        cdk.Stack.of(this).formatArn({
                            service: 'rds',
                            resource: 'cluster',
                            resourceName: clusterIdentifier,
                            arnFormat: cdk.ArnFormat.COLON_RESOURCE_NAME,
                            account: cdk.Stack.of(this).account,
                            region: cdk.Stack.of(this).region,
                        }),
                    ],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(crPolicy, [
            {
                id: 'AwsSolutions-IAM4',
                reason: 'The AWSLambdaBasicExecutionRole managed policy is required for ' +
                    'the Lambda function to write logs to CloudWatch.',
            },
            {
                id: 'AwsSolutions-IAM5',
                reason: 'This policy is required to allow the custom resource to create a ' +
                    'network interface for the Aurora cluster and it has to be wildcard.',
            },
        ], true);
        return crPolicy;
    }
    generateResourceArn(clusterIdentifier) {
        return cdk.Stack.of(this).formatArn({
            service: 'rds',
            resource: 'cluster',
            resourceName: clusterIdentifier,
            region: cdk.Stack.of(this).region,
            account: cdk.Stack.of(this).account,
            arnFormat: cdk.ArnFormat.COLON_RESOURCE_NAME,
        });
    }
    setupDatabaseClusterResources(vpc, secret, clusterIdentifier, auroraSecurityGroupId) {
        const resourceArn = this.generateResourceArn(clusterIdentifier);
        const auroraSecurityGroup = ec2.SecurityGroup.fromLookupById(this, 'ExistingSG', auroraSecurityGroupId);
        return {
            vpc,
            secret,
            resourceArn,
            auroraSecurityGroup,
            clusterIdentifier,
        };
    }
    createLambdaSecurityGroup(vpc) {
        return new ec2.SecurityGroup(this, 'LambdaSecurityGroup', {
            vpc,
            securityGroupName: 'lambda-security-group',
            description: 'Security group for Lambda access to Aurora',
        });
    }
    addIngressRuleToAuroraSecurityGroup(lambdaSecurityGroup, auroraSecurityGroup) {
        auroraSecurityGroup.addIngressRule(lambdaSecurityGroup, ec2.Port.tcp(5432), 'Allow PostgreSQL access from Lambda security group');
    }
    setupCustomResource(databaseClusterResources, lambdaSecurityGroup, auroraPgCRPolicy) {
        const customResource = (0, custom_resource_provider_helper_1.buildCustomResourceProvider)({
            providerName: 'AmazonAuroraPgVectorCRProvider',
            vpc: databaseClusterResources.vpc,
            securityGroup: lambdaSecurityGroup,
            codePath: path.join(__dirname, '../../../lambda/amazon-aurora-pgvector-custom-resources'),
            handler: 'custom_resources.on_event',
            runtime: cdk.aws_lambda.Runtime.PYTHON_3_12,
        });
        const crProvider = customResource.getProvider(this);
        crProvider.role.addManagedPolicy(auroraPgCRPolicy);
        databaseClusterResources.secret.grantRead(crProvider.role);
        const auroraPgVector = new cdk.CustomResource(this, 'AuroraPgVector', {
            resourceType: 'Custom::AmazonAuroraPgVector',
            serviceToken: crProvider.serviceToken,
            properties: {
                SecretName: databaseClusterResources.secret.secretName || '',
                ClusterIdentifier: databaseClusterResources.clusterIdentifier,
                DatabaseName: this.databaseName,
                TableName: this.tableName,
                VectorDimensions: this.embeddingsModelVectorDimension,
                PrimaryKeyField: this.primaryKeyField,
                SchemaName: this.schemaName,
                VectorField: this.vectorField,
                TextField: this.textField,
                MetadataField: this.metadataField,
            },
        });
        auroraPgVector.node.addDependency(auroraPgCRPolicy);
        return auroraPgVector;
    }
}
class ExistingAmazonAuroraVectorStore extends BaseAmazonAuroraVectorStore {
    constructor(scope, id, props) {
        super(scope, id, props);
        const databaseClusterResources = this.setupDatabaseClusterResources(props.vpc, props.secret, props.clusterIdentifier, props.auroraSecurityGroupId);
        const auroraPgCRPolicy = this.createAuroraPgCRPolicy(databaseClusterResources.clusterIdentifier);
        const lambdaSecurityGroup = this.createLambdaSecurityGroup(databaseClusterResources.vpc);
        this.addIngressRuleToAuroraSecurityGroup(lambdaSecurityGroup, databaseClusterResources.auroraSecurityGroup);
        this.resourceArn = this.generateResourceArn(databaseClusterResources.clusterIdentifier);
        this.credentialsSecretArn = databaseClusterResources.secret.secretArn;
        this.vpc = databaseClusterResources.vpc;
        (0, vpc_helper_1.AddAwsServiceEndpoint)(scope, this.vpc, [
            vpc_helper_1.ServiceEndpointTypeEnum.SECRETS_MANAGER,
            vpc_helper_1.ServiceEndpointTypeEnum.BEDROCK_RUNTIME,
        ]);
        this.setupCustomResource(databaseClusterResources, lambdaSecurityGroup, auroraPgCRPolicy);
    }
}
exports.ExistingAmazonAuroraVectorStore = ExistingAmazonAuroraVectorStore;
_a = JSII_RTTI_SYMBOL_1;
ExistingAmazonAuroraVectorStore[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.amazonaurora.ExistingAmazonAuroraVectorStore", version: "0.1.285" };
class AmazonAuroraVectorStore extends BaseAmazonAuroraVectorStore {
    /**
     * Creates an instance of AmazonAuroraVectorStore using existing Aurora Vector Store properties.
     * You need to provide your existing Aurora Vector Store properties
     * such as `databaseName`, `clusterIdentifier`, `vpc` where database is deployed,
     * `secret` containing username and password for authentication to database,
     * and `auroraSecurityGroupId` with the value of a security group id that was
     * used for the database.
     *
     * @param scope - The scope in which to define the construct.
     * @param id - The ID of the construct.
     * @param props - The properties of the existing Aurora Vector Store.
     * @returns An instance of AmazonAuroraVectorStore.
     */
    static fromExistingAuroraVectorStore(scope, id, props) {
        return new ExistingAmazonAuroraVectorStore(scope, id, props);
    }
    constructor(scope, id, props) {
        super(scope, id, props);
        const databaseClusterResources = this.createDatabaseCluster(props.postgreSQLVersion ?? exports.SupportedPostgreSQLVersions.AURORA_POSTGRESQL_V15_5, props.vpc);
        const auroraPgCRPolicy = this.createAuroraPgCRPolicy(databaseClusterResources.clusterIdentifier);
        const lambdaSecurityGroup = this.createLambdaSecurityGroup(databaseClusterResources.vpc);
        this.addIngressRuleToAuroraSecurityGroup(lambdaSecurityGroup, databaseClusterResources.auroraSecurityGroup);
        this.resourceArn = databaseClusterResources.resourceArn;
        this.credentialsSecretArn = databaseClusterResources.secret.secretArn;
        this.vpc = databaseClusterResources.vpc;
        (0, vpc_helper_1.AddAwsServiceEndpoint)(scope, this.vpc, [
            vpc_helper_1.ServiceEndpointTypeEnum.SECRETS_MANAGER,
            vpc_helper_1.ServiceEndpointTypeEnum.BEDROCK_RUNTIME,
        ]);
        const auroraPgVector = this.setupCustomResource(databaseClusterResources, lambdaSecurityGroup, auroraPgCRPolicy);
        auroraPgVector.node.addDependency(databaseClusterResources.auroraCluster);
    }
    createDatabaseCluster(postgreSQLVersion, existingVpc) {
        const vpc = (0, vpc_helper_1.buildVpc)(this, {
            existingVpc: existingVpc,
            vpcName: `${this.node.id}-vpc`,
        });
        vpc.addFlowLog('VpcFlowLog', {
            destination: ec2.FlowLogDestination.toCloudWatchLogs(),
        });
        const auroraSecurityGroup = new ec2.SecurityGroup(this, 'AuroraSecurityGroup', {
            vpc,
            securityGroupName: 'aurora-security-group',
            description: 'Security group for access to Aurora from Lambda',
        });
        const auroraCluster = new rds.DatabaseCluster(this, 'AuroraCluster', {
            engine: rds.DatabaseClusterEngine.auroraPostgres({
                version: postgreSQLVersion,
            }),
            credentials: rds.Credentials.fromGeneratedSecret('postgres'),
            clusterIdentifier: `aurora-serverless-vector-cluster-${cdk.Stack.of(this).account}`,
            defaultDatabaseName: this.databaseName,
            vpc,
            vpcSubnets: { subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
            securityGroups: [auroraSecurityGroup],
            iamAuthentication: true,
            storageEncrypted: true,
            serverlessV2MinCapacity: 0.5,
            serverlessV2MaxCapacity: 4,
            writer: rds.ClusterInstance.serverlessV2('AuroraServerlessWriter'),
            readers: [rds.ClusterInstance.serverlessV2('AuroraServerlessReader', { scaleWithWriter: true })],
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        const resourceArn = cdk.Stack.of(this).formatArn({
            service: 'rds',
            resource: 'cluster',
            resourceName: auroraCluster.clusterIdentifier,
            arnFormat: cdk.ArnFormat.COLON_RESOURCE_NAME,
        });
        auroraCluster.addRotationSingleUser();
        const cfnDbCluster = auroraCluster.node.defaultChild;
        cfnDbCluster.addOverride('Properties.EnableHttpEndpoint', true);
        cdk_nag_1.NagSuppressions.addResourceSuppressions(auroraCluster, [
            {
                id: 'AwsSolutions-RDS10',
                reason: 'Deletion protection is disabled to make sure a customer can stop ' +
                    'incurring charges if they want to delete the construct.',
            },
        ], true);
        return {
            vpc,
            auroraCluster,
            resourceArn,
            secret: auroraCluster.secret,
            auroraSecurityGroup,
            clusterIdentifier: auroraCluster.clusterIdentifier,
        };
    }
}
exports.AmazonAuroraVectorStore = AmazonAuroraVectorStore;
_b = JSII_RTTI_SYMBOL_1;
AmazonAuroraVectorStore[_b] = { fqn: "@cdklabs/generative-ai-cdk-constructs.amazonaurora.AmazonAuroraVectorStore", version: "0.1.285" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVyb3JhLXZlY3Rvci1zdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jZGstbGliL2FtYXpvbmF1cm9yYS9hdXJvcmEtdmVjdG9yLXN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFFSCw2QkFBNkI7QUFDN0IsbUNBQW1DO0FBQ25DLDJDQUEyQztBQUMzQywyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBRTNDLHFDQUEwQztBQUMxQywyQ0FBdUM7QUFDdkMsMEdBQW1HO0FBQ25HLHNEQUFvRTtBQUNwRSxnRUFBMkc7QUFFM0c7O0dBRUc7QUFDVSxRQUFBLDJCQUEyQixHQUFHO0lBQ3pDLHdCQUF3QixFQUFFLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxTQUFTO0lBQ25FLHdCQUF3QixFQUFFLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxTQUFTO0lBQ25FLHVCQUF1QixFQUFFLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxRQUFRO0lBQ2pFLHVCQUF1QixFQUFFLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxRQUFRO0lBQ2pFLHVCQUF1QixFQUFFLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxRQUFRO0NBQ3pELENBQUM7QUErSVg7OztHQUdHO0FBQ0gsTUFBZSwyQkFBNEIsU0FBUSxzQkFBUztJQTJDMUQsWUFDRSxLQUFnQixFQUNoQixFQUFVLEVBQ1YsS0FBMEU7UUFFMUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQjs7O1VBR0U7UUFDRixJQUFJLENBQUMsWUFBWSxHQUFHLG1CQUFtQixJQUFJLEtBQUssQ0FBQyxDQUFDO1lBQ2hELEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLElBQUksbUJBQW1CLENBQUM7UUFFakUsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsVUFBVSxJQUFJLHFCQUFxQixDQUFDO1FBQzVELElB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IG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgcmRzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1yZHMnO1xuaW1wb3J0ICogYXMgc2VjcmV0c21hbmFnZXIgZnJvbSAnYXdzLWNkay1saWIvYXdzLXNlY3JldHNtYW5hZ2VyJztcbmltcG9ydCB7IE5hZ1N1cHByZXNzaW9ucyB9IGZyb20gJ2Nkay1uYWcnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBidWlsZEN1c3RvbVJlc291cmNlUHJvdmlkZXIgfSBmcm9tICcuLi8uLi9jb21tb24vaGVscGVycy9jdXN0b20tcmVzb3VyY2UtcHJvdmlkZXItaGVscGVyJztcbmltcG9ydCB7IGdlbmVyYXRlUGh5c2ljYWxOYW1lVjIgfSBmcm9tICcuLi8uLi9jb21tb24vaGVscGVycy91dGlscyc7XG5pbXBvcnQgeyBBZGRBd3NTZXJ2aWNlRW5kcG9pbnQsIGJ1aWxkVnBjLCBTZXJ2aWNlRW5kcG9pbnRUeXBlRW51bSB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL3ZwYy1oZWxwZXInO1xuXG4vKipcbiAqIExpc3Qgb2Ygc3VwcG9ydGVkIHZlcnNpb25zIG9mIFBvc3RncmVTUUwgZm9yIEF1cm9yYSBjbHVzdGVyLlxuICovXG5leHBvcnQgY29uc3QgU3VwcG9ydGVkUG9zdGdyZVNRTFZlcnNpb25zID0ge1xuICBBVVJPUkFfUE9TVEdSRVNRTF9WMTJfMTY6IHJkcy5BdXJvcmFQb3N0Z3Jlc0VuZ2luZVZlcnNpb24uVkVSXzEyXzE2LFxuICBBVVJPUkFfUE9TVEdSRVNRTF9WMTNfMTI6IHJkcy5BdXJvcmFQb3N0Z3Jlc0VuZ2luZVZlcnNpb24uVkVSXzEzXzEyLFxuICBBVVJPUkFfUE9TVEdSRVNRTF9WMTRfOTogcmRzLkF1cm9yYVBvc3RncmVzRW5naW5lVmVyc2lvbi5WRVJfMTRfOSxcbiAgQVVST1JBX1BPU1RHUkVTUUxfVjE1XzQ6IHJkcy5BdXJvcmFQb3N0Z3Jlc0VuZ2luZVZlcnNpb24uVkVSXzE1XzQsXG4gIEFVUk9SQV9QT1NUR1JFU1FMX1YxNV81OiByZHMuQXVyb3JhUG9zdGdyZXNFbmdpbmVWZXJzaW9uLlZFUl8xNV81LFxufSBhcyBjb25zdDtcblxuZXhwb3J0IHR5cGUgU3VwcG9ydGVkUG9zdGdyZVNRTFZlcnNpb25zID0gdHlwZW9mIFN1cHBvcnRlZFBvc3RncmVTUUxWZXJzaW9uc1tcbiAga2V5b2YgdHlwZW9mIFN1cHBvcnRlZFBvc3RncmVTUUxWZXJzaW9uc1xuXTtcblxuLyoqXG4gKiBCYXNlIHByb3BlcnRpZXMgZm9yIGFuIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQmFzZUF1cm9yYVZlY3RvclN0b3JlUHJvcHMge1xuICAvKipcbiAgICogVGhlIHNjaGVtYSBuYW1lIGZvciB0aGUgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICovXG4gIHJlYWRvbmx5IHNjaGVtYU5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBmaWVsZCBuYW1lIGZvciB0aGUgdmVjdG9yIGNvbHVtbiBpbiB0aGUgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICovXG4gIHJlYWRvbmx5IHZlY3RvckZpZWxkPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgZmllbGQgbmFtZSBmb3IgdGhlIHRleHQgY29sdW1uIGluIHRoZSBBdXJvcmEgVmVjdG9yIFN0b3JlLlxuICAgKi9cbiAgcmVhZG9ubHkgdGV4dEZpZWxkPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgZmllbGQgbmFtZSBmb3IgdGhlIG1ldGFkYXRhIGNvbHVtbiBpbiB0aGUgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICovXG4gIHJlYWRvbmx5IG1ldGFkYXRhRmllbGQ/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSBmb3IgdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqL1xuICByZWFkb25seSB0YWJsZU5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBwcmltYXJ5IGtleSBmaWVsZCBmb3IgdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUgdGFibGUuXG4gICAqL1xuICByZWFkb25seSBwcmltYXJ5S2V5RmllbGQ/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBlbWJlZGRpbmdzIG1vZGVsIGRpbWVuc2lvbiB1c2VkIGZvciB0aGUgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICogVGhlIHZlY3RvciBkaW1lbnNpb25zIG9mIHRoZSBtb2RlbCBtdXN0IG1hdGNoIHRoZSBkaW1lbnNpb25zXG4gICAqIHVzZWQgaW4gdGhlIEtub3dsZWRnZUJhc2UgY29uc3RydWN0LlxuICAgKi9cbiAgcmVhZG9ubHkgZW1iZWRkaW5nc01vZGVsVmVjdG9yRGltZW5zaW9uOiBudW1iZXI7XG59XG5cbi8qKlxuICogUHJvcGVydGllcyBmb3IgY29uZmlndXJpbmcgYW4gQW1hem9uIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQW1hem9uQXVyb3JhVmVjdG9yU3RvcmVQcm9wcyBleHRlbmRzIEJhc2VBdXJvcmFWZWN0b3JTdG9yZVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBkYXRhYmFzZSBmb3IgdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqL1xuICByZWFkb25seSBkYXRhYmFzZU5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSB2ZXJzaW9uIG9mIFBvc3RncmVTUUwgdG8gdXNlIGZvciB0aGUgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICogQnkgZGVmYXVsdCwgdGhlIGxhdGVzdCBzdXBwb3J0ZWQgdmVyc2lvbiB3aWxsIGJlIHVzZWQuXG4gICAqL1xuICByZWFkb25seSBwb3N0Z3JlU1FMVmVyc2lvbj86IFN1cHBvcnRlZFBvc3RncmVTUUxWZXJzaW9ucztcblxuICAvKipcbiAgICogVXNlcidzIFZQQyBpbiB3aGljaCB0aGV5IHdhbnQgdG8gZGVwbG95IEF1cm9yYSBEYXRhYmFzZS5cbiAgICovXG4gIHJlYWRvbmx5IHZwYz86IGVjMi5JVnBjO1xufVxuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGFuIGV4aXN0aW5nIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gKiBZb3UgZGF0YWJhc2UgbXVzdCBoYXZlIFRDUC9JUCBwb3J0IHRoYXQgdGhlXG4gKiBkYXRhYmFzZSB3aWxsIHVzZSBmb3IgYXBwbGljYXRpb24gY29ubmVjdGlvbnNcbiAqIHNldCB1cCBmb3IgYDU0MzJgLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV4aXN0aW5nQW1hem9uQXVyb3JhVmVjdG9yU3RvcmVQcm9wcyBleHRlbmRzIEJhc2VBdXJvcmFWZWN0b3JTdG9yZVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBkYXRhYmFzZSBmb3IgdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqL1xuICByZWFkb25seSBkYXRhYmFzZU5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHVuaXF1ZSBjbHVzdGVyIGlkZW50aWZpZXIgb2YgeW91ciBBdXJvcmEgUkRTIGNsdXN0ZXIuXG4gICAqL1xuICByZWFkb25seSBjbHVzdGVySWRlbnRpZmllcjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIGluIHdoaWNoIHRoZSBleGlzdGluZyBBdXJvcmEgVmVjdG9yIFN0b3JlIGlzIGxvY2F0ZWQuXG4gICAqL1xuICByZWFkb25seSB2cGM6IGVjMi5JVnBjO1xuXG4gIC8qKlxuICAgKiBUaGUgc2VjcmV0IGNvbnRhaW5pbmcgdGhlIGRhdGFiYXNlIGNyZWRlbnRpYWxzLlxuICAgKiBUaGUgc2VjcmV0IG11c3QgY29udGFpbiBgaG9zdGAsIGBwb3J0YCwgYHVzZXJuYW1lYCxcbiAgICogYHBhc3N3b3JkYCBhbmQgYGRibmFtZWAgdmFsdWVzLlxuICAgKi9cbiAgcmVhZG9ubHkgc2VjcmV0OiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0O1xuXG4gIC8qKlxuICAgKiBUaGUgaWQgb2YgdGhlIHNlY3VyaXR5IGdyb3VwIGFzc29jaWF0ZWQgd2l0aCB0aGUgUkRTIEF1cm9yYSBpbnN0YW5jZS5cbiAgICogVGhpcyBzZWN1cml0eSBncm91cCBhbGxvd3MgYWNjZXNzIHRvIHRoZSBBdXJvcmEgVmVjdG9yIFN0b3JlIGZyb20gTGFtYmRhJ3NcbiAgICogY3VzdG9tIHJlc291cmNlIHJ1bm5pbmcgcGdWZWN0b3IgU1FMIGNvbW1hbmRzLlxuICAgKi9cbiAgcmVhZG9ubHkgYXVyb3JhU2VjdXJpdHlHcm91cElkOiBzdHJpbmc7XG59XG5cbi8qKlxuICogSW50ZXJmYWNlIHJlcHJlc2VudGluZyB0aGUgcmVzb3VyY2VzIHJlcXVpcmVkIGZvciBhIGRhdGFiYXNlIGNsdXN0ZXIuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzIHtcblxuICAvKipcbiAgICogVGhlIEFtYXpvbiBBdXJvcmEgUkRTIGNsdXN0ZXIuXG4gICAqL1xuICByZWFkb25seSBhdXJvcmFDbHVzdGVyPzogcmRzLkRhdGFiYXNlQ2x1c3RlcjtcblxuICAvKipcbiAgICogVGhlIEFSTiBvZiB5b3VyIGV4aXN0aW5nIEFtYXpvbiBBdXJvcmEgREIgY2x1c3Rlci5cbiAgICovXG4gIHJlYWRvbmx5IHJlc291cmNlQXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSB1bmlxdWUgY2x1c3RlciBpZGVudGlmaWVyIG9mIHRoZSBBdXJvcmEgUkRTIGNsdXN0ZXIuXG4gICAqL1xuICByZWFkb25seSBjbHVzdGVySWRlbnRpZmllcjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIGluIHdoaWNoIHRoZSBkYXRhYmFzZSBjbHVzdGVyIGlzIGxvY2F0ZWQuXG4gICAqL1xuICByZWFkb25seSB2cGM6IGVjMi5JVnBjO1xuXG4gIC8qKlxuICAgKiBUaGUgc2VjcmV0IGNvbnRhaW5pbmcgdGhlIGRhdGFiYXNlIGNyZWRlbnRpYWxzLlxuICAgKiBUaGUgc2VjcmV0IG11c3QgY29udGFpbiBgdXNlcm5hbWVgIGFuZCBgcGFzc3dvcmRgIHZhbHVlcy5cbiAgICovXG4gIHJlYWRvbmx5IHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldDtcblxuICAvKipcbiAgICogVGhlIHNlY3VyaXR5IGdyb3VwIGFzc29jaWF0ZWQgd2l0aCB0aGUgQXVyb3JhIGNsdXN0ZXIuXG4gICAqL1xuICByZWFkb25seSBhdXJvcmFTZWN1cml0eUdyb3VwOiBlYzIuU2VjdXJpdHlHcm91cDtcbn1cblxuLyoqXG4gKiBCYXNlIGNsYXNzIGZvciBBbWF6b24gQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAqIEhhbmRsZXMgYm90aCB0aGUgY3JlYXRpb24gb2YgYSBuZXcgQXVyb3JhIFZlY3RvciBTdG9yZSBvciB0aGUgdXNhZ2Ugb2YgYW4gZXhpc3RpbmcgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAqL1xuYWJzdHJhY3QgY2xhc3MgQmFzZUFtYXpvbkF1cm9yYVZlY3RvclN0b3JlIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgLyoqXG4gICAqIFRoZSBzY2hlbWEgbmFtZSBmb3IgdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc2NoZW1hTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgZmllbGQgbmFtZSBmb3IgdGhlIHZlY3RvciBjb2x1bW4gaW4gdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdmVjdG9yRmllbGQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIGZpZWxkIG5hbWUgZm9yIHRoZSB0ZXh0IGNvbHVtbiBpbiB0aGUgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB0ZXh0RmllbGQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIGZpZWxkIG5hbWUgZm9yIHRoZSBtZXRhZGF0YSBjb2x1bW4gaW4gdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbWV0YWRhdGFGaWVsZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZGF0YWJhc2UgZm9yIHRoZSBBdXJvcmEgVmVjdG9yIFN0b3JlLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGRhdGFiYXNlTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgdGFibGUgZm9yIHRoZSBBdXJvcmEgVmVjdG9yIFN0b3JlLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHRhYmxlTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgcHJpbWFyeSBrZXkgZmllbGQgZm9yIHRoZSBBdXJvcmEgVmVjdG9yIFN0b3JlIHRhYmxlLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHByaW1hcnlLZXlGaWVsZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgZW1iZWRkaW5ncyBtb2RlbCBkaW1lbnNpb24gdXNlZCBmb3IgdGhlIEF1cm9yYSBWZWN0b3IgU3RvcmUuXG4gICAqIFRoZSB2ZWN0b3IgZGltZW5zaW9ucyBvZiB0aGUgbW9kZWwgbXVzdCBtYXRjaCB0aGUgZGltZW5zaW9uc1xuICAgKiB1c2VkIGluIHRoZSBLbm93bGVkZ2VCYXNlIGNvbnN0cnVjdC5cbiAgICovXG4gIHJlYWRvbmx5IGVtYmVkZGluZ3NNb2RlbFZlY3RvckRpbWVuc2lvbjogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogQW1hem9uQXVyb3JhVmVjdG9yU3RvcmVQcm9wcyB8IEV4aXN0aW5nQW1hem9uQXVyb3JhVmVjdG9yU3RvcmVQcm9wcyxcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8qKlxuICAgICogU2V0dXAgZGF0YWJhc2VOYW1lIGJhc2VkIG9uIGlmIGl0IGlzIHByb3ZpZGVkIGluIHRoZSBwcm9wcyBvciBub3RcbiAgICAqIGFuZCBiYXNlZCBvbiB3aGV0aGVyIGl0IGlzIGFuIGV4aXN0aW5nIEF1cm9yYSBWZWN0b3IgU3RvcmUgb3Igbm90LlxuICAgICovXG4gICAgdGhpcy5kYXRhYmFzZU5hbWUgPSAnY2x1c3RlcklkZW50aWZpZXInIGluIHByb3BzID9cbiAgICAgIHByb3BzLmRhdGFiYXNlTmFtZSA6IHByb3BzLmRhdGFiYXNlTmFtZSA/PyAnYmVkcm9ja192ZWN0b3JfZGInO1xuXG4gICAgdGhpcy5zY2hlbWFOYW1lID0gcHJvcHMuc2NoZW1hTmFtZSA/PyAnYmVkcm9ja19pbnRlZ3JhdGlvbic7XG4gICAgdGhpcy52ZWN0b3JGaWVsZCA9IHByb3BzLnZlY3RvckZpZWxkID8/ICdlbWJlZGRpbmcnO1xuICAgIHRoaXMudGV4dEZpZWxkID0gcHJvcHMudGV4dEZpZWxkID8/ICdjaHVua3MnO1xuICAgIHRoaXMubWV0YWRhdGFGaWVsZCA9IHByb3BzLm1ldGFkYXRhRmllbGQgPz8gJ21ldGFkYXRhJztcbiAgICB0aGlzLnRhYmxlTmFtZSA9IHByb3BzLnRhYmxlTmFtZSA/PyAnYmVkcm9ja19rYic7XG4gICAgdGhpcy5wcmltYXJ5S2V5RmllbGQgPSBwcm9wcy5wcmltYXJ5S2V5RmllbGQgPz8gJ2lkJztcbiAgICB0aGlzLmVtYmVkZGluZ3NNb2RlbFZlY3RvckRpbWVuc2lvbiA9IHByb3BzLmVtYmVkZGluZ3NNb2RlbFZlY3RvckRpbWVuc2lvbjtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVBdXJvcmFQZ0NSUG9saWN5KGNsdXN0ZXJJZGVudGlmaWVyOiBzdHJpbmcpOiBpYW0uTWFuYWdlZFBvbGljeSB7XG4gICAgY29uc3QgY3JQb2xpY3kgPSBuZXcgaWFtLk1hbmFnZWRQb2xpY3kodGhpcywgJ0F1cm9yYVBnUG9saWN5Jywge1xuICAgICAgbWFuYWdlZFBvbGljeU5hbWU6IGdlbmVyYXRlUGh5c2ljYWxOYW1lVjIodGhpcywgJ0F1cm9yYVBnUG9saWN5Jywge1xuICAgICAgICBtYXhMZW5ndGg6IDMyLFxuICAgICAgICBsb3dlcjogdHJ1ZSxcbiAgICAgIH0pLFxuICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgJ2VjMjpEZXNjcmliZUluc3RhbmNlcycsXG4gICAgICAgICAgICAnZWMyOkNyZWF0ZU5ldHdvcmtJbnRlcmZhY2UnLFxuICAgICAgICAgICAgJ2VjMjpBdHRhY2hOZXR3b3JrSW50ZXJmYWNlJyxcbiAgICAgICAgICAgICdlYzI6RGVzY3JpYmVOZXR3b3JrSW50ZXJmYWNlcycsXG4gICAgICAgICAgICAnYXV0b3NjYWxpbmc6Q29tcGxldGVMaWZlY3ljbGVBY3Rpb24nLFxuICAgICAgICAgICAgJ2VjMjpEZWxldGVOZXR3b3JrSW50ZXJmYWNlJyxcbiAgICAgICAgICBdLFxuICAgICAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgICAgIH0pLFxuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgYWN0aW9uczogWydyZHM6RGVzY3JpYmVEQkNsdXN0ZXJzJ10sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbXG4gICAgICAgICAgICBjZGsuU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgICAgICAgICAgc2VydmljZTogJ3JkcycsXG4gICAgICAgICAgICAgIHJlc291cmNlOiAnY2x1c3RlcicsXG4gICAgICAgICAgICAgIHJlc291cmNlTmFtZTogY2x1c3RlcklkZW50aWZpZXIsXG4gICAgICAgICAgICAgIGFybkZvcm1hdDogY2RrLkFybkZvcm1hdC5DT0xPTl9SRVNPVVJDRV9OQU1FLFxuICAgICAgICAgICAgICBhY2NvdW50OiBjZGsuU3RhY2sub2YodGhpcykuYWNjb3VudCxcbiAgICAgICAgICAgICAgcmVnaW9uOiBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgXSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgTmFnU3VwcHJlc3Npb25zLmFkZFJlc291cmNlU3VwcHJlc3Npb25zKFxuICAgICAgY3JQb2xpY3ksXG4gICAgICBbXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogJ0F3c1NvbHV0aW9ucy1JQU00JyxcbiAgICAgICAgICByZWFzb246ICdUaGUgQVdTTGFtYmRhQmFzaWNFeGVjdXRpb25Sb2xlIG1hbmFnZWQgcG9saWN5IGlzIHJlcXVpcmVkIGZvciAnICtcbiAgICAgICAgICAgICAgICAgICd0aGUgTGFtYmRhIGZ1bmN0aW9uIHRvIHdyaXRlIGxvZ3MgdG8gQ2xvdWRXYXRjaC4nLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtSUFNNScsXG4gICAgICAgICAgcmVhc29uOiAnVGhpcyBwb2xpY3kgaXMgcmVxdWlyZWQgdG8gYWxsb3cgdGhlIGN1c3RvbSByZXNvdXJjZSB0byBjcmVhdGUgYSAnICtcbiAgICAgICAgICAgICAgICAgICduZXR3b3JrIGludGVyZmFjZSBmb3IgdGhlIEF1cm9yYSBjbHVzdGVyIGFuZCBpdCBoYXMgdG8gYmUgd2lsZGNhcmQuJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICB0cnVlLFxuICAgICk7XG5cbiAgICByZXR1cm4gY3JQb2xpY3k7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2VuZXJhdGVSZXNvdXJjZUFybihjbHVzdGVySWRlbnRpZmllcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY2RrLlN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICBzZXJ2aWNlOiAncmRzJyxcbiAgICAgIHJlc291cmNlOiAnY2x1c3RlcicsXG4gICAgICByZXNvdXJjZU5hbWU6IGNsdXN0ZXJJZGVudGlmaWVyLFxuICAgICAgcmVnaW9uOiBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgYWNjb3VudDogY2RrLlN0YWNrLm9mKHRoaXMpLmFjY291bnQsXG4gICAgICBhcm5Gb3JtYXQ6IGNkay5Bcm5Gb3JtYXQuQ09MT05fUkVTT1VSQ0VfTkFNRSxcbiAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXR1cERhdGFiYXNlQ2x1c3RlclJlc291cmNlcyhcbiAgICB2cGM6IGVjMi5JVnBjLFxuICAgIHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldCxcbiAgICBjbHVzdGVySWRlbnRpZmllcjogc3RyaW5nLFxuICAgIGF1cm9yYVNlY3VyaXR5R3JvdXBJZDogc3RyaW5nLFxuICApOiBEYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMge1xuICAgIGNvbnN0IHJlc291cmNlQXJuID0gdGhpcy5nZW5lcmF0ZVJlc291cmNlQXJuKGNsdXN0ZXJJZGVudGlmaWVyKTtcbiAgICBjb25zdCBhdXJvcmFTZWN1cml0eUdyb3VwID0gZWMyLlNlY3VyaXR5R3JvdXAuZnJvbUxvb2t1cEJ5SWQoXG4gICAgICB0aGlzLFxuICAgICAgJ0V4aXN0aW5nU0cnLFxuICAgICAgYXVyb3JhU2VjdXJpdHlHcm91cElkLFxuICAgICkgYXMgZWMyLlNlY3VyaXR5R3JvdXA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdnBjLFxuICAgICAgc2VjcmV0LFxuICAgICAgcmVzb3VyY2VBcm4sXG4gICAgICBhdXJvcmFTZWN1cml0eUdyb3VwLFxuICAgICAgY2x1c3RlcklkZW50aWZpZXIsXG4gICAgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVMYW1iZGFTZWN1cml0eUdyb3VwKHZwYzogZWMyLklWcGMpOiBlYzIuU2VjdXJpdHlHcm91cCB7XG4gICAgcmV0dXJuIG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnTGFtYmRhU2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIHZwYyxcbiAgICAgIHNlY3VyaXR5R3JvdXBOYW1lOiAnbGFtYmRhLXNlY3VyaXR5LWdyb3VwJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnU2VjdXJpdHkgZ3JvdXAgZm9yIExhbWJkYSBhY2Nlc3MgdG8gQXVyb3JhJyxcbiAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRJbmdyZXNzUnVsZVRvQXVyb3JhU2VjdXJpdHlHcm91cChcbiAgICBsYW1iZGFTZWN1cml0eUdyb3VwOiBlYzIuU2VjdXJpdHlHcm91cCxcbiAgICBhdXJvcmFTZWN1cml0eUdyb3VwOiBlYzIuU2VjdXJpdHlHcm91cCxcbiAgKSB7XG4gICAgYXVyb3JhU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGxhbWJkYVNlY3VyaXR5R3JvdXAsXG4gICAgICBlYzIuUG9ydC50Y3AoNTQzMiksXG4gICAgICAnQWxsb3cgUG9zdGdyZVNRTCBhY2Nlc3MgZnJvbSBMYW1iZGEgc2VjdXJpdHkgZ3JvdXAnLFxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2V0dXBDdXN0b21SZXNvdXJjZShcbiAgICBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXM6IERhdGFiYXNlQ2x1c3RlclJlc291cmNlcyxcbiAgICBsYW1iZGFTZWN1cml0eUdyb3VwOiBlYzIuU2VjdXJpdHlHcm91cCxcbiAgICBhdXJvcmFQZ0NSUG9saWN5OiBpYW0uTWFuYWdlZFBvbGljeSxcbiAgKSA6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gICAgY29uc3QgY3VzdG9tUmVzb3VyY2UgPSBidWlsZEN1c3RvbVJlc291cmNlUHJvdmlkZXIoe1xuICAgICAgcHJvdmlkZXJOYW1lOiAnQW1hem9uQXVyb3JhUGdWZWN0b3JDUlByb3ZpZGVyJyxcbiAgICAgIHZwYzogZGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzLnZwYyxcbiAgICAgIHNlY3VyaXR5R3JvdXA6IGxhbWJkYVNlY3VyaXR5R3JvdXAsXG4gICAgICBjb2RlUGF0aDogcGF0aC5qb2luKFxuICAgICAgICBfX2Rpcm5hbWUsICcuLi8uLi8uLi9sYW1iZGEvYW1hem9uLWF1cm9yYS1wZ3ZlY3Rvci1jdXN0b20tcmVzb3VyY2VzJyksXG4gICAgICBoYW5kbGVyOiAnY3VzdG9tX3Jlc291cmNlcy5vbl9ldmVudCcsXG4gICAgICBydW50aW1lOiBjZGsuYXdzX2xhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzEyLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY3JQcm92aWRlciA9IGN1c3RvbVJlc291cmNlLmdldFByb3ZpZGVyKHRoaXMpO1xuICAgIGNyUHJvdmlkZXIucm9sZS5hZGRNYW5hZ2VkUG9saWN5KGF1cm9yYVBnQ1JQb2xpY3kpO1xuICAgIGRhdGFiYXNlQ2x1c3RlclJlc291cmNlcy5zZWNyZXQuZ3JhbnRSZWFkKGNyUHJvdmlkZXIucm9sZSk7XG5cbiAgICBjb25zdCBhdXJvcmFQZ1ZlY3RvciA9IG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgJ0F1cm9yYVBnVmVjdG9yJywge1xuICAgICAgcmVzb3VyY2VUeXBlOiAnQ3VzdG9tOjpBbWF6b25BdXJvcmFQZ1ZlY3RvcicsXG4gICAgICBzZXJ2aWNlVG9rZW46IGNyUHJvdmlkZXIuc2VydmljZVRva2VuLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBTZWNyZXROYW1lOiBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuc2VjcmV0LnNlY3JldE5hbWUgfHwgJycsXG4gICAgICAgIENsdXN0ZXJJZGVudGlmaWVyOiBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuY2x1c3RlcklkZW50aWZpZXIsXG4gICAgICAgIERhdGFiYXNlTmFtZTogdGhpcy5kYXRhYmFzZU5hbWUsXG4gICAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICAgIFZlY3RvckRpbWVuc2lvbnM6IHRoaXMuZW1iZWRkaW5nc01vZGVsVmVjdG9yRGltZW5zaW9uLFxuICAgICAgICBQcmltYXJ5S2V5RmllbGQ6IHRoaXMucHJpbWFyeUtleUZpZWxkLFxuICAgICAgICBTY2hlbWFOYW1lOiB0aGlzLnNjaGVtYU5hbWUsXG4gICAgICAgIFZlY3RvckZpZWxkOiB0aGlzLnZlY3RvckZpZWxkLFxuICAgICAgICBUZXh0RmllbGQ6IHRoaXMudGV4dEZpZWxkLFxuICAgICAgICBNZXRhZGF0YUZpZWxkOiB0aGlzLm1ldGFkYXRhRmllbGQsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIGF1cm9yYVBnVmVjdG9yLm5vZGUuYWRkRGVwZW5kZW5jeShhdXJvcmFQZ0NSUG9saWN5KTtcblxuICAgIHJldHVybiBhdXJvcmFQZ1ZlY3RvcjtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXhpc3RpbmdBbWF6b25BdXJvcmFWZWN0b3JTdG9yZSBleHRlbmRzIEJhc2VBbWF6b25BdXJvcmFWZWN0b3JTdG9yZSB7XG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHlvdXIgQW1hem9uIEF1cm9yYSBEQiBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHJlc291cmNlQXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBTZWNyZXQgQVJOIG9mIHlvdXIgQW1hem9uIEF1cm9yYSBEQiBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNyZWRlbnRpYWxzU2VjcmV0QXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBWUEMgb2YgeW91ciBBbWF6b24gQXVyb3JhIERCIGNsdXN0ZXIuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdnBjOiBlYzIuSVZwYztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEV4aXN0aW5nQW1hem9uQXVyb3JhVmVjdG9yU3RvcmVQcm9wcyxcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMgPSB0aGlzLnNldHVwRGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzKFxuICAgICAgcHJvcHMudnBjLFxuICAgICAgcHJvcHMuc2VjcmV0LFxuICAgICAgcHJvcHMuY2x1c3RlcklkZW50aWZpZXIsXG4gICAgICBwcm9wcy5hdXJvcmFTZWN1cml0eUdyb3VwSWQsXG4gICAgKTtcblxuICAgIGNvbnN0IGF1cm9yYVBnQ1JQb2xpY3kgPSB0aGlzLmNyZWF0ZUF1cm9yYVBnQ1JQb2xpY3koZGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzLmNsdXN0ZXJJZGVudGlmaWVyKTtcbiAgICBjb25zdCBsYW1iZGFTZWN1cml0eUdyb3VwID0gdGhpcy5jcmVhdGVMYW1iZGFTZWN1cml0eUdyb3VwKGRhdGFiYXNlQ2x1c3RlclJlc291cmNlcy52cGMpO1xuICAgIHRoaXMuYWRkSW5ncmVzc1J1bGVUb0F1cm9yYVNlY3VyaXR5R3JvdXAobGFtYmRhU2VjdXJpdHlHcm91cCwgZGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzLmF1cm9yYVNlY3VyaXR5R3JvdXApO1xuXG4gICAgdGhpcy5yZXNvdXJjZUFybiA9IHRoaXMuZ2VuZXJhdGVSZXNvdXJjZUFybihkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuY2x1c3RlcklkZW50aWZpZXIpO1xuICAgIHRoaXMuY3JlZGVudGlhbHNTZWNyZXRBcm4gPSBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuc2VjcmV0LnNlY3JldEFybjtcbiAgICB0aGlzLnZwYyA9IGRhdGFiYXNlQ2x1c3RlclJlc291cmNlcy52cGM7XG5cbiAgICBBZGRBd3NTZXJ2aWNlRW5kcG9pbnQoc2NvcGUsIHRoaXMudnBjLCBbXG4gICAgICBTZXJ2aWNlRW5kcG9pbnRUeXBlRW51bS5TRUNSRVRTX01BTkFHRVIsXG4gICAgICBTZXJ2aWNlRW5kcG9pbnRUeXBlRW51bS5CRURST0NLX1JVTlRJTUUsXG4gICAgXSk7XG5cbiAgICB0aGlzLnNldHVwQ3VzdG9tUmVzb3VyY2UoZGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzLCBsYW1iZGFTZWN1cml0eUdyb3VwLCBhdXJvcmFQZ0NSUG9saWN5KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQW1hem9uQXVyb3JhVmVjdG9yU3RvcmUgZXh0ZW5kcyBCYXNlQW1hem9uQXVyb3JhVmVjdG9yU3RvcmUge1xuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBBbWF6b25BdXJvcmFWZWN0b3JTdG9yZSB1c2luZyBleGlzdGluZyBBdXJvcmEgVmVjdG9yIFN0b3JlIHByb3BlcnRpZXMuXG4gICAqIFlvdSBuZWVkIHRvIHByb3ZpZGUgeW91ciBleGlzdGluZyBBdXJvcmEgVmVjdG9yIFN0b3JlIHByb3BlcnRpZXNcbiAgICogc3VjaCBhcyBgZGF0YWJhc2VOYW1lYCwgYGNsdXN0ZXJJZGVudGlmaWVyYCwgYHZwY2Agd2hlcmUgZGF0YWJhc2UgaXMgZGVwbG95ZWQsXG4gICAqIGBzZWNyZXRgIGNvbnRhaW5pbmcgdXNlcm5hbWUgYW5kIHBhc3N3b3JkIGZvciBhdXRoZW50aWNhdGlvbiB0byBkYXRhYmFzZSxcbiAgICogYW5kIGBhdXJvcmFTZWN1cml0eUdyb3VwSWRgIHdpdGggdGhlIHZhbHVlIG9mIGEgc2VjdXJpdHkgZ3JvdXAgaWQgdGhhdCB3YXNcbiAgICogdXNlZCBmb3IgdGhlIGRhdGFiYXNlLlxuICAgKlxuICAgKiBAcGFyYW0gc2NvcGUgLSBUaGUgc2NvcGUgaW4gd2hpY2ggdG8gZGVmaW5lIHRoZSBjb25zdHJ1Y3QuXG4gICAqIEBwYXJhbSBpZCAtIFRoZSBJRCBvZiB0aGUgY29uc3RydWN0LlxuICAgKiBAcGFyYW0gcHJvcHMgLSBUaGUgcHJvcGVydGllcyBvZiB0aGUgZXhpc3RpbmcgQXVyb3JhIFZlY3RvciBTdG9yZS5cbiAgICogQHJldHVybnMgQW4gaW5zdGFuY2Ugb2YgQW1hem9uQXVyb3JhVmVjdG9yU3RvcmUuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb21FeGlzdGluZ0F1cm9yYVZlY3RvclN0b3JlKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogRXhpc3RpbmdBbWF6b25BdXJvcmFWZWN0b3JTdG9yZVByb3BzLFxuICApOiBFeGlzdGluZ0FtYXpvbkF1cm9yYVZlY3RvclN0b3JlIHtcbiAgICByZXR1cm4gbmV3IEV4aXN0aW5nQW1hem9uQXVyb3JhVmVjdG9yU3RvcmUoc2NvcGUsIGlkLCBwcm9wcyk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIEFSTiBvZiB5b3VyIEFtYXpvbiBBdXJvcmEgREIgY2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSByZXNvdXJjZUFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgU2VjcmV0IEFSTiBvZiB5b3VyIEFtYXpvbiBBdXJvcmEgREIgY2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBjcmVkZW50aWFsc1NlY3JldEFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIG9mIHlvdXIgQW1hem9uIEF1cm9yYSBEQiBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHZwYzogZWMyLklWcGM7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIHByb3BzOiBBbWF6b25BdXJvcmFWZWN0b3JTdG9yZVByb3BzLFxuICApIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIGNvbnN0IGRhdGFiYXNlQ2x1c3RlclJlc291cmNlcyA9IHRoaXMuY3JlYXRlRGF0YWJhc2VDbHVzdGVyKFxuICAgICAgcHJvcHMucG9zdGdyZVNRTFZlcnNpb24gPz8gU3VwcG9ydGVkUG9zdGdyZVNRTFZlcnNpb25zLkFVUk9SQV9QT1NUR1JFU1FMX1YxNV81LFxuICAgICAgcHJvcHMudnBjLFxuICAgICk7XG4gICAgY29uc3QgYXVyb3JhUGdDUlBvbGljeSA9IHRoaXMuY3JlYXRlQXVyb3JhUGdDUlBvbGljeShkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuY2x1c3RlcklkZW50aWZpZXIpO1xuICAgIGNvbnN0IGxhbWJkYVNlY3VyaXR5R3JvdXAgPSB0aGlzLmNyZWF0ZUxhbWJkYVNlY3VyaXR5R3JvdXAoZGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzLnZwYyk7XG4gICAgdGhpcy5hZGRJbmdyZXNzUnVsZVRvQXVyb3JhU2VjdXJpdHlHcm91cChsYW1iZGFTZWN1cml0eUdyb3VwLCBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuYXVyb3JhU2VjdXJpdHlHcm91cCk7XG5cbiAgICB0aGlzLnJlc291cmNlQXJuID0gZGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzLnJlc291cmNlQXJuO1xuICAgIHRoaXMuY3JlZGVudGlhbHNTZWNyZXRBcm4gPSBkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMuc2VjcmV0LnNlY3JldEFybjtcbiAgICB0aGlzLnZwYyA9IGRhdGFiYXNlQ2x1c3RlclJlc291cmNlcy52cGM7XG5cbiAgICBBZGRBd3NTZXJ2aWNlRW5kcG9pbnQoc2NvcGUsIHRoaXMudnBjLCBbXG4gICAgICBTZXJ2aWNlRW5kcG9pbnRUeXBlRW51bS5TRUNSRVRTX01BTkFHRVIsXG4gICAgICBTZXJ2aWNlRW5kcG9pbnRUeXBlRW51bS5CRURST0NLX1JVTlRJTUUsXG4gICAgXSk7XG5cbiAgICBjb25zdCBhdXJvcmFQZ1ZlY3RvciA9IHRoaXMuc2V0dXBDdXN0b21SZXNvdXJjZShkYXRhYmFzZUNsdXN0ZXJSZXNvdXJjZXMsIGxhbWJkYVNlY3VyaXR5R3JvdXAsIGF1cm9yYVBnQ1JQb2xpY3kpO1xuXG4gICAgYXVyb3JhUGdWZWN0b3Iubm9kZS5hZGREZXBlbmRlbmN5KGRhdGFiYXNlQ2x1c3RlclJlc291cmNlcy5hdXJvcmFDbHVzdGVyISk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURhdGFiYXNlQ2x1c3RlcihcbiAgICBwb3N0Z3JlU1FMVmVyc2lvbjogU3VwcG9ydGVkUG9zdGdyZVNRTFZlcnNpb25zLFxuICAgIGV4aXN0aW5nVnBjOiBlYzIuSVZwYyB8IHVuZGVmaW5lZCxcbiAgKTogRGF0YWJhc2VDbHVzdGVyUmVzb3VyY2VzIHtcbiAgICBjb25zdCB2cGMgPSBidWlsZFZwYyh0aGlzLCB7XG4gICAgICBleGlzdGluZ1ZwYzogZXhpc3RpbmdWcGMsXG4gICAgICB2cGNOYW1lOiBgJHt0aGlzLm5vZGUuaWR9LXZwY2AsXG4gICAgfSk7XG4gICAgdnBjLmFkZEZsb3dMb2coJ1ZwY0Zsb3dMb2cnLCB7XG4gICAgICBkZXN0aW5hdGlvbjogZWMyLkZsb3dMb2dEZXN0aW5hdGlvbi50b0Nsb3VkV2F0Y2hMb2dzKCksXG4gICAgfSk7XG5cbiAgICBjb25zdCBhdXJvcmFTZWN1cml0eUdyb3VwID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsICdBdXJvcmFTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjLFxuICAgICAgc2VjdXJpdHlHcm91cE5hbWU6ICdhdXJvcmEtc2VjdXJpdHktZ3JvdXAnLFxuICAgICAgZGVzY3JpcHRpb246ICdTZWN1cml0eSBncm91cCBmb3IgYWNjZXNzIHRvIEF1cm9yYSBmcm9tIExhbWJkYScsXG4gICAgfSk7XG5cbiAgICBjb25zdCBhdXJvcmFDbHVzdGVyID0gbmV3IHJkcy5EYXRhYmFzZUNsdXN0ZXIodGhpcywgJ0F1cm9yYUNsdXN0ZXInLCB7XG4gICAgICBlbmdpbmU6IHJkcy5EYXRhYmFzZUNsdXN0ZXJFbmdpbmUuYXVyb3JhUG9zdGdyZXMoe1xuICAgICAgICB2ZXJzaW9uOiBwb3N0Z3JlU1FMVmVyc2lvbixcbiAgICAgIH0pLFxuICAgICAgY3JlZGVudGlhbHM6IHJkcy5DcmVkZW50aWFscy5mcm9tR2VuZXJhdGVkU2VjcmV0KCdwb3N0Z3JlcycpLFxuICAgICAgY2x1c3RlcklkZW50aWZpZXI6IGBhdXJvcmEtc2VydmVybGVzcy12ZWN0b3ItY2x1c3Rlci0ke2Nkay5TdGFjay5vZih0aGlzKS5hY2NvdW50fWAsXG4gICAgICBkZWZhdWx0RGF0YWJhc2VOYW1lOiB0aGlzLmRhdGFiYXNlTmFtZSxcbiAgICAgIHZwYyxcbiAgICAgIHZwY1N1Ym5ldHM6IHsgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9JU09MQVRFRCB9LFxuICAgICAgc2VjdXJpdHlHcm91cHM6IFthdXJvcmFTZWN1cml0eUdyb3VwXSxcbiAgICAgIGlhbUF1dGhlbnRpY2F0aW9uOiB0cnVlLFxuICAgICAgc3RvcmFnZUVuY3J5cHRlZDogdHJ1ZSxcbiAgICAgIHNlcnZlcmxlc3NWMk1pbkNhcGFjaXR5OiAwLjUsXG4gICAgICBzZXJ2ZXJsZXNzVjJNYXhDYXBhY2l0eTogNCxcbiAgICAgIHdyaXRlcjogcmRzLkNsdXN0ZXJJbnN0YW5jZS5zZXJ2ZXJsZXNzVjIoJ0F1cm9yYVNlcnZlcmxlc3NXcml0ZXInKSxcbiAgICAgIHJlYWRlcnM6IFtyZHMuQ2x1c3Rlckluc3RhbmNlLnNlcnZlcmxlc3NWMignQXVyb3JhU2VydmVybGVzc1JlYWRlcicsXG4gICAgICAgIHsgc2NhbGVXaXRoV3JpdGVyOiB0cnVlIH0pXSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG4gICAgY29uc3QgcmVzb3VyY2VBcm4gPSBjZGsuU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgIHNlcnZpY2U6ICdyZHMnLFxuICAgICAgcmVzb3VyY2U6ICdjbHVzdGVyJyxcbiAgICAgIHJlc291cmNlTmFtZTogYXVyb3JhQ2x1c3Rlci5jbHVzdGVySWRlbnRpZmllcixcbiAgICAgIGFybkZvcm1hdDogY2RrLkFybkZvcm1hdC5DT0xPTl9SRVNPVVJDRV9OQU1FLFxuICAgIH0pO1xuXG4gICAgYXVyb3JhQ2x1c3Rlci5hZGRSb3RhdGlvblNpbmdsZVVzZXIoKTtcblxuICAgIGNvbnN0IGNmbkRiQ2x1c3RlciA9IGF1cm9yYUNsdXN0ZXIubm9kZS5kZWZhdWx0Q2hpbGQgYXMgcmRzLkNmbkRCQ2x1c3RlcjtcbiAgICBjZm5EYkNsdXN0ZXIuYWRkT3ZlcnJpZGUoJ1Byb3BlcnRpZXMuRW5hYmxlSHR0cEVuZHBvaW50JywgdHJ1ZSk7XG5cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMoXG4gICAgICBhdXJvcmFDbHVzdGVyLFxuICAgICAgW1xuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtUkRTMTAnLFxuICAgICAgICAgIHJlYXNvbjogJ0RlbGV0aW9uIHByb3RlY3Rpb24gaXMgZGlzYWJsZWQgdG8gbWFrZSBzdXJlIGEgY3VzdG9tZXIgY2FuIHN0b3AgJyArXG4gICAgICAgICAgICAgICAgICAnaW5jdXJyaW5nIGNoYXJnZXMgaWYgdGhleSB3YW50IHRvIGRlbGV0ZSB0aGUgY29uc3RydWN0LicsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgdHJ1ZSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHZwYyxcbiAgICAgIGF1cm9yYUNsdXN0ZXIsXG4gICAgICByZXNvdXJjZUFybixcbiAgICAgIHNlY3JldDogYXVyb3JhQ2x1c3Rlci5zZWNyZXQhLFxuICAgICAgYXVyb3JhU2VjdXJpdHlHcm91cCxcbiAgICAgIGNsdXN0ZXJJZGVudGlmaWVyOiBhdXJvcmFDbHVzdGVyLmNsdXN0ZXJJZGVudGlmaWVyLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==