"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CustomSageMakerEndpoint = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const cdk = require("aws-cdk-lib");
const applicationautoscaling = require("aws-cdk-lib/aws-applicationautoscaling");
const iam = require("aws-cdk-lib/aws-iam");
const kms = require("aws-cdk-lib/aws-kms");
const sagemaker = require("aws-cdk-lib/aws-sagemaker");
const sns = require("aws-cdk-lib/aws-sns");
const sagemaker_endpoint_base_1 = require("./sagemaker-endpoint-base");
const base_class_1 = require("../../../common/base-class");
class CustomSageMakerEndpoint extends sagemaker_endpoint_base_1.SageMakerEndpointBase {
    constructor(scope, id, props) {
        super(scope, id);
        const baseProps = {
            constructName: base_class_1.ConstructName.CUSTOMSAGEMAKERENDPOINT,
            constructId: id,
        };
        // No lambda function to use AWS SDK for service metric
        const lambdaFunctions = [];
        this.updateConstructUsageMetricCode(baseProps, scope, lambdaFunctions);
        this.instanceType = props.instanceType;
        this.modelId = props.modelId;
        this.instanceCount = Math.max(1, props.instanceCount ?? 1);
        this.role = props.role ?? this.createSageMakerRole();
        this.grantPrincipal = this.role;
        this.modelDataUrl = props.modelDataUrl;
        this.startupHealthCheckTimeoutInSeconds = props.startupHealthCheckTimeoutInSeconds ?? 600;
        this.environment = props.environment;
        this.modelDataDownloadTimeoutInSeconds = props.modelDataDownloadTimeoutInSeconds ?? 600;
        const image = props.container.bind(this, this.grantPrincipal).imageName;
        const modelIdStr = this.modelId.split('/').join('-').split('.').join('-');
        const isArtifactCompressed = this.modelDataUrl.endsWith('.tar.gz');
        const model = new sagemaker.CfnModel(scope, `${modelIdStr}-model-${id}`, {
            executionRoleArn: this.role.roleArn,
            primaryContainer: isArtifactCompressed ? {
                image,
                mode: 'SingleModel',
                modelDataUrl: this.modelDataUrl,
                environment: {
                    SAGEMAKER_REGION: cdk.Aws.REGION,
                    ...this.environment,
                },
            } : {
                image,
                mode: 'SingleModel',
                modelDataSource: {
                    s3DataSource: {
                        compressionType: 'None',
                        s3DataType: 'S3Prefix',
                        s3Uri: this.modelDataUrl,
                    },
                },
                environment: {
                    SAGEMAKER_REGION: cdk.Aws.REGION,
                    ...this.environment,
                },
            },
            tags: [
                {
                    key: 'modelId',
                    value: this.modelId,
                },
            ],
            vpcConfig: props.vpcConfig,
        });
        const productionVariant = {
            instanceType: this.instanceType.toString(),
            initialVariantWeight: 1,
            initialInstanceCount: this.instanceCount,
            variantName: 'AllTraffic',
            volumeSizeInGb: props.volumeSizeInGb,
            modelName: model.getAtt('ModelName').toString(),
            containerStartupHealthCheckTimeoutInSeconds: this.startupHealthCheckTimeoutInSeconds,
            modelDataDownloadTimeoutInSeconds: this.modelDataDownloadTimeoutInSeconds,
        };
        const endpointConfig = new sagemaker.CfnEndpointConfig(scope, `EndpointConfig-${id}`, {
            productionVariants: [productionVariant],
        });
        if (props.asyncInference) {
            // build sns topics for success and failure
            const successTopic = this.buildSnsTopic(`success-topic-${id}`, 'Success Topic');
            const failureTopic = this.buildSnsTopic(`failure-topic-${id}`, 'Failure Topic');
            this.errorTopic = failureTopic;
            this.successTopic = successTopic;
            // configure async inference
            const asyncInferenceConfigProperty = {
                outputConfig: {
                    s3FailurePath: props.asyncInference.failurePath,
                    s3OutputPath: props.asyncInference.outputPath,
                    notificationConfig: {
                        successTopic: successTopic.topicArn,
                        errorTopic: failureTopic.topicArn,
                    },
                },
                clientConfig: {
                    maxConcurrentInvocationsPerInstance: props.asyncInference.maxConcurrentInvocationsPerInstance ?? 10,
                },
            };
            endpointConfig.asyncInferenceConfig = asyncInferenceConfigProperty;
        }
        endpointConfig.addDependency(model);
        const endpoint = new sagemaker.CfnEndpoint(scope, `${modelIdStr}-endpoint-${id}`, {
            endpointName: props.endpointName,
            endpointConfigName: endpointConfig.getAtt('EndpointConfigName').toString(),
            tags: [
                {
                    key: 'modelId',
                    value: this.modelId,
                },
            ],
        });
        endpoint.addDependency(endpointConfig);
        this.cfnModel = model;
        this.cfnEndpoint = endpoint;
        this.cfnEndpointConfig = endpointConfig;
        this.endpointArn = endpoint.ref;
        this.scalingPolicy = this.buildScalingPolicy(endpoint, productionVariant, props);
    }
    addToRolePolicy(statement) {
        if (!this.role) {
            return;
        }
        this.role.addToPolicy(statement);
    }
    grantInvoke(grantee) {
        return iam.Grant.addToPrincipal({
            grantee,
            actions: ['sagemaker:InvokeEndpoint'],
            resourceArns: [this.endpointArn],
        });
    }
    buildScalingPolicy(endpoint, productionVariants, props) {
        const resourceId = `endpoint/${endpoint.attrEndpointName}/variant/${productionVariants.variantName}`;
        const scalableTarget = new applicationautoscaling.ScalableTarget(this, 'ScalableTarget', {
            serviceNamespace: applicationautoscaling.ServiceNamespace.SAGEMAKER,
            resourceId: resourceId,
            scalableDimension: 'sagemaker:variant:DesiredInstanceCount',
            minCapacity: props.minCapacity ?? 1,
            maxCapacity: props.maxCapacity ?? 2,
        });
        scalableTarget.node.addDependency(endpoint);
        const approximateBacklogMetric = new cdk.aws_cloudwatch.Metric({
            namespace: 'AWS/SageMaker',
            metricName: 'ApproximateBacklogSizePerInstance',
            dimensionsMap: {
                Endpoint: endpoint.attrEndpointName,
                Variant: productionVariants.variantName,
            },
            statistic: 'Average',
            period: cdk.Duration.minutes(5),
        });
        const scalingPolicy = new applicationautoscaling.StepScalingPolicy(this, 'ScalingPolicy', {
            scalingTarget: scalableTarget,
            adjustmentType: applicationautoscaling.AdjustmentType.CHANGE_IN_CAPACITY,
            metric: approximateBacklogMetric,
            scalingSteps: [
                { upper: 0, change: -1, lower: 0 },
                { change: 1, lower: 0.5 },
            ],
            cooldown: cdk.Duration.minutes(5),
            datapointsToAlarm: 1,
            evaluationPeriods: 1,
        });
        return scalingPolicy;
    }
    buildSnsTopic(topicName, displayName) {
        const masterKey = kms.Alias.fromAliasName(this, `aws-managed-key-${topicName}`, 'alias/aws/sns');
        const topic = new sns.Topic(this, topicName, {
            topicName,
            displayName,
            masterKey: masterKey,
        });
        topic.grantPublish(this.role);
        topic.addToResourcePolicy(new iam.PolicyStatement({
            actions: ['sns:Publish'],
            effect: iam.Effect.DENY,
            resources: [topic.topicArn],
            conditions: {
                Bool: {
                    'aws:SecureTransport': 'false',
                },
            },
            principals: [new iam.AnyPrincipal()],
        }));
        return topic;
    }
}
exports.CustomSageMakerEndpoint = CustomSageMakerEndpoint;
_a = JSII_RTTI_SYMBOL_1;
CustomSageMakerEndpoint[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.CustomSageMakerEndpoint", version: "0.1.285" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLXNhZ2VtYWtlci1lbmRwb2ludC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9wYXR0ZXJucy9nZW4tYWkvYXdzLW1vZGVsLWRlcGxveW1lbnQtc2FnZW1ha2VyL2N1c3RvbS1zYWdlbWFrZXItZW5kcG9pbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7R0FXRztBQUNILG1DQUFtQztBQUNuQyxpRkFBaUY7QUFDakYsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyx1REFBdUQ7QUFDdkQsMkNBQTJDO0FBRzNDLHVFQUFrRTtBQUVsRSwyREFBMkQ7QUE0QjNELE1BQWEsdUJBQXdCLFNBQVEsK0NBQXFCO0lBbUJoRSxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQW1DO1FBQzNFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxTQUFTLEdBQW1CO1lBQ2hDLGFBQWEsRUFBRSwwQkFBYSxDQUFDLHVCQUF1QjtZQUNwRCxXQUFXLEVBQUUsRUFBRTtTQUNoQixDQUFDO1FBRUYsdURBQXVEO1FBQ3ZELE1BQU0sZUFBZSxHQUF5QyxFQUFFLENBQUM7UUFDakUsSUFBSSxDQUFDLDhCQUE4QixDQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFeEUsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUM3QixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxhQUFhLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQ3JELElBQUksQ0FB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RUFBRSxXQUFtQjtRQUMxRCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLFNBQVMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBRWpHLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1lBQzNDLFNBQVM7WUFDVCxXQUFXO1lBQ1gsU0FBUyxFQUFFLFNBQVM7U0FDckIsQ0FBQyxDQUFDO1FBRUgsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFOUIsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUNoRCxPQUFPLEVBQUUsQ0FBQyxhQUFhLENBQUM7WUFDeEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSTtZQUN2QixTQUFTLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1lBQzNCLFVBQVUsRUFBRTtnQkFDVixJQUFJLEVBQUU7b0JBQ0oscUJBQXFCLEVBQUUsT0FBTztpQkFDL0I7YUFDRjtZQUNELFVBQVUsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO1NBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUosT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOztBQTdPSCwwREE4T0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGFwcGxpY2F0aW9uYXV0b3NjYWxpbmcgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwcGxpY2F0aW9uYXV0b3NjYWxpbmcnO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMga21zIGZyb20gJ2F3cy1jZGstbGliL2F3cy1rbXMnO1xuaW1wb3J0ICogYXMgc2FnZW1ha2VyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zYWdlbWFrZXInO1xuaW1wb3J0ICogYXMgc25zIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zbnMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBDb250YWluZXJJbWFnZSB9IGZyb20gJy4vY29udGFpbmVyLWltYWdlJztcbmltcG9ydCB7IFNhZ2VNYWtlckVuZHBvaW50QmFzZSB9IGZyb20gJy4vc2FnZW1ha2VyLWVuZHBvaW50LWJhc2UnO1xuaW1wb3J0IHsgU2FnZU1ha2VySW5zdGFuY2VUeXBlIH0gZnJvbSAnLi9zYWdlbWFrZXItaW5zdGFuY2UtdHlwZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3ROYW1lIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2Jhc2UtY2xhc3MnO1xuaW1wb3J0IHsgQmFzZUNsYXNzUHJvcHMgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vYmFzZS1jbGFzcy9iYXNlLWNsYXNzJztcblxuZXhwb3J0IGludGVyZmFjZSBBc3luY0luZmVyZW5jZUNvbmZpZyB7XG4gIHJlYWRvbmx5IGZhaWx1cmVQYXRoOiBzdHJpbmc7XG4gIHJlYWRvbmx5IG91dHB1dFBhdGg6IHN0cmluZztcbiAgcmVhZG9ubHkgbWF4Q29uY3VycmVudEludm9jYXRpb25zUGVySW5zdGFuY2U/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9tU2FnZU1ha2VyRW5kcG9pbnRQcm9wcyB7XG4gIHJlYWRvbmx5IG1vZGVsSWQ6IHN0cmluZztcbiAgcmVhZG9ubHkgZW5kcG9pbnROYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGluc3RhbmNlVHlwZTogU2FnZU1ha2VySW5zdGFuY2VUeXBlO1xuICByZWFkb25seSBtaW5DYXBhY2l0eT86bnVtYmVyO1xuICByZWFkb25seSBtYXhDYXBhY2l0eT86bnVtYmVyO1xuICByZWFkb25seSBjb250YWluZXI6IENvbnRhaW5lckltYWdlO1xuICByZWFkb25seSBpbnN0YW5jZUNvdW50PzogbnVtYmVyO1xuICByZWFkb25seSByb2xlPzogaWFtLlJvbGU7XG4gIHJlYWRvbmx5IGVudmlyb25tZW50PzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcmVhZG9ubHkgc3RhcnR1cEhlYWx0aENoZWNrVGltZW91dEluU2Vjb25kcz86IG51bWJlcjtcbiAgcmVhZG9ubHkgbW9kZWxEYXRhRG93bmxvYWRUaW1lb3V0SW5TZWNvbmRzPzogbnVtYmVyO1xuICByZWFkb25seSB2b2x1bWVTaXplSW5HYj86IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgcmVhZG9ubHkgdnBjQ29uZmlnPzogc2FnZW1ha2VyLkNmbk1vZGVsLlZwY0NvbmZpZ1Byb3BlcnR5IHwgdW5kZWZpbmVkO1xuICByZWFkb25seSBtb2RlbERhdGFVcmw6IHN0cmluZztcbiAgcmVhZG9ubHkgYXN5bmNJbmZlcmVuY2U/OiBBc3luY0luZmVyZW5jZUNvbmZpZyB8IHVuZGVmaW5lZDtcblxufVxuXG5leHBvcnQgY2xhc3MgQ3VzdG9tU2FnZU1ha2VyRW5kcG9pbnQgZXh0ZW5kcyBTYWdlTWFrZXJFbmRwb2ludEJhc2UgaW1wbGVtZW50cyBpYW0uSUdyYW50YWJsZSB7XG4gIHB1YmxpYyByZWFkb25seSBncmFudFByaW5jaXBhbDogaWFtLklQcmluY2lwYWw7XG4gIHB1YmxpYyByZWFkb25seSBlbmRwb2ludEFybjogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgY2ZuTW9kZWw6IHNhZ2VtYWtlci5DZm5Nb2RlbDtcbiAgcHVibGljIHJlYWRvbmx5IGNmbkVuZHBvaW50OiBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnQ7XG4gIHB1YmxpYyByZWFkb25seSBjZm5FbmRwb2ludENvbmZpZzogc2FnZW1ha2VyLkNmbkVuZHBvaW50Q29uZmlnO1xuICBwdWJsaWMgcmVhZG9ubHkgc2NhbGluZ1BvbGljeTogYXBwbGljYXRpb25hdXRvc2NhbGluZy5TdGVwU2NhbGluZ1BvbGljeTtcbiAgcHVibGljIHJlYWRvbmx5IHN1Y2Nlc3NUb3BpYz86IHNucy5Ub3BpYztcbiAgcHVibGljIHJlYWRvbmx5IGVycm9yVG9waWM/OiBzbnMuVG9waWM7XG5cbiAgcHVibGljIHJlYWRvbmx5IGluc3RhbmNlVHlwZT86IFNhZ2VNYWtlckluc3RhbmNlVHlwZTtcbiAgcHVibGljIHJlYWRvbmx5IGluc3RhbmNlQ291bnQ6IG51bWJlcjtcbiAgcHVibGljIHJlYWRvbmx5IHJvbGU6IGlhbS5Sb2xlO1xuICBwdWJsaWMgcmVhZG9ubHkgbW9kZWxEYXRhVXJsOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBtb2RlbElkOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBtb2RlbERhdGFEb3dubG9hZFRpbWVvdXRJblNlY29uZHM6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFydHVwSGVhbHRoQ2hlY2tUaW1lb3V0SW5TZWNvbmRzOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgZW52aXJvbm1lbnQ/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBDdXN0b21TYWdlTWFrZXJFbmRwb2ludFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IGJhc2VQcm9wczogQmFzZUNsYXNzUHJvcHMgPSB7XG4gICAgICBjb25zdHJ1Y3ROYW1lOiBDb25zdHJ1Y3ROYW1lLkNVU1RPTVNBR0VNQUtFUkVORFBPSU5ULFxuICAgICAgY29uc3RydWN0SWQ6IGlkLFxuICAgIH07XG5cbiAgICAvLyBObyBsYW1iZGEgZnVuY3Rpb24gdG8gdXNlIEFXUyBTREsgZm9yIHNlcnZpY2UgbWV0cmljXG4gICAgY29uc3QgbGFtYmRhRnVuY3Rpb25zOiBjZGsuYXdzX2xhbWJkYS5Eb2NrZXJJbWFnZUZ1bmN0aW9uW10gPSBbXTtcbiAgICB0aGlzLnVwZGF0ZUNvbnN0cnVjdFVzYWdlTWV0cmljQ29kZSggYmFzZVByb3BzLCBzY29wZSwgbGFtYmRhRnVuY3Rpb25zKTtcblxuICAgIHRoaXMuaW5zdGFuY2VUeXBlID0gcHJvcHMuaW5zdGFuY2VUeXBlO1xuICAgIHRoaXMubW9kZWxJZCA9IHByb3BzLm1vZGVsSWQ7XG4gICAgdGhpcy5pbnN0YW5jZUNvdW50ID0gTWF0aC5tYXgoMSwgcHJvcHMuaW5zdGFuY2VDb3VudCA/PyAxKTtcbiAgICB0aGlzLnJvbGUgPSBwcm9wcy5yb2xlID8/IHRoaXMuY3JlYXRlU2FnZU1ha2VyUm9sZSgpO1xuICAgIHRoaXMuZ3JhbnRQcmluY2lwYWwgPSB0aGlzLnJvbGU7XG4gICAgdGhpcy5tb2RlbERhdGFVcmwgPSBwcm9wcy5tb2RlbERhdGFVcmw7XG4gICAgdGhpcy5zdGFydHVwSGVhbHRoQ2hlY2tUaW1lb3V0SW5TZWNvbmRzID0gcHJvcHMuc3RhcnR1cEhlYWx0aENoZWNrVGltZW91dEluU2Vjb25kcyA/PyA2MDA7XG4gICAgdGhpcy5lbnZpcm9ubWVudCA9IHByb3BzLmVudmlyb25tZW50O1xuICAgIHRoaXMubW9kZWxEYXRhRG93bmxvYWRUaW1lb3V0SW5TZWNvbmRzID0gcHJvcHMubW9kZWxEYXRhRG93bmxvYWRUaW1lb3V0SW5TZWNvbmRzID8/IDYwMDtcblxuICAgIGNvbnN0IGltYWdlID0gcHJvcHMuY29udGFpbmVyLmJpbmQodGhpcywgdGhpcy5ncmFudFByaW5jaXBhbCkuaW1hZ2VOYW1lO1xuICAgIGNvbnN0IG1vZGVsSWRTdHIgPSB0aGlzLm1vZGVsSWQuc3BsaXQoJy8nKS5qb2luKCctJykuc3BsaXQoJy4nKS5qb2luKCctJyk7XG4gICAgY29uc3QgaXNBcnRpZmFjdENvbXByZXNzZWQgPSB0aGlzLm1vZGVsRGF0YVVybC5lbmRzV2l0aCgnLnRhci5neicpO1xuXG4gICAgY29uc3QgbW9kZWwgPSBuZXcgc2FnZW1ha2VyLkNmbk1vZGVsKHNjb3BlLCBgJHttb2RlbElkU3RyfS1tb2RlbC0ke2lkfWAsIHtcbiAgICAgIGV4ZWN1dGlvblJvbGVBcm46IHRoaXMucm9sZS5yb2xlQXJuLFxuICAgICAgcHJpbWFyeUNvbnRhaW5lcjogaXNBcnRpZmFjdENvbXByZXNzZWQgPyB7XG4gICAgICAgIGltYWdlLFxuICAgICAgICBtb2RlOiAnU2luZ2xlTW9kZWwnLFxuICAgICAgICBtb2RlbERhdGFVcmw6IHRoaXMubW9kZWxEYXRhVXJsLFxuICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgIFNBR0VNQUtFUl9SRUdJT046IGNkay5Bd3MuUkVHSU9OLFxuICAgICAgICAgIC4uLnRoaXMuZW52aXJvbm1lbnQsXG4gICAgICAgIH0sXG4gICAgICB9IDoge1xuICAgICAgICBpbWFnZSxcbiAgICAgICAgbW9kZTogJ1NpbmdsZU1vZGVsJyxcbiAgICAgICAgbW9kZWxEYXRhU291cmNlOiB7XG4gICAgICAgICAgczNEYXRhU291cmNlOiB7XG4gICAgICAgICAgICBjb21wcmVzc2lvblR5cGU6ICdOb25lJyxcbiAgICAgICAgICAgIHMzRGF0YVR5cGU6ICdTM1ByZWZpeCcsXG4gICAgICAgICAgICBzM1VyaTogdGhpcy5tb2RlbERhdGFVcmwsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBTQUdFTUFLRVJfUkVHSU9OOiBjZGsuQXdzLlJFR0lPTixcbiAgICAgICAgICAuLi50aGlzLmVudmlyb25tZW50LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHRhZ3M6IFtcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ21vZGVsSWQnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLm1vZGVsSWQsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgdnBjQ29uZmlnOiBwcm9wcy52cGNDb25maWcsXG4gICAgfSk7XG5cbiAgICBjb25zdCBwcm9kdWN0aW9uVmFyaWFudDogc2FnZW1ha2VyLkNmbkVuZHBvaW50Q29uZmlnLlByb2R1Y3Rpb25WYXJpYW50UHJvcGVydHkgPVxuICAgICAge1xuICAgICAgICBpbnN0YW5jZVR5cGU6IHRoaXMuaW5zdGFuY2VUeXBlLnRvU3RyaW5nKCksXG4gICAgICAgIGluaXRpYWxWYXJpYW50V2VpZ2h0OiAxLFxuICAgICAgICBpbml0aWFsSW5zdGFuY2VDb3VudDogdGhpcy5pbnN0YW5jZUNvdW50LFxuICAgICAgICB2YXJpYW50TmFtZTogJ0FsbFRyYWZmaWMnLFxuICAgICAgICB2b2x1bWVTaXplSW5HYjogcHJvcHMudm9sdW1lU2l6ZUluR2IsXG4gICAgICAgIG1vZGVsTmFtZTogbW9kZWwuZ2V0QXR0KCdNb2RlbE5hbWUnKS50b1N0cmluZygpLFxuICAgICAgICBjb250YWluZXJTdGFydHVwSGVhbHRoQ2hlY2tUaW1lb3V0SW5TZWNvbmRzOiB0aGlzLnN0YXJ0dXBIZWFsdGhDaGVja1RpbWVvdXRJblNlY29uZHMsXG4gICAgICAgIG1vZGVsRGF0YURvd25sb2FkVGltZW91dEluU2Vjb25kczogdGhpcy5tb2RlbERhdGFEb3dubG9hZFRpbWVvdXRJblNlY29uZHMsXG4gICAgICB9O1xuXG5cbiAgICBjb25zdCBlbmRwb2ludENvbmZpZyA9IG5ldyBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnRDb25maWcoc2NvcGUsIGBFbmRwb2ludENvbmZpZy0ke2lkfWAsIHtcbiAgICAgIHByb2R1Y3Rpb25WYXJpYW50czogW3Byb2R1Y3Rpb25WYXJpYW50XSxcbiAgICB9KTtcblxuXG4gICAgaWYgKHByb3BzLmFzeW5jSW5mZXJlbmNlKSB7XG5cbiAgICAgIC8vIGJ1aWxkIHNucyB0b3BpY3MgZm9yIHN1Y2Nlc3MgYW5kIGZhaWx1cmVcbiAgICAgIGNvbnN0IHN1Y2Nlc3NUb3BpYyA9IHRoaXMuYnVpbGRTbnNUb3BpYyhgc3VjY2Vzcy10b3BpYy0ke2lkfWAsICdTdWNjZXNzIFRvcGljJyk7XG4gICAgICBjb25zdCBmYWlsdXJlVG9waWMgPSB0aGlzLmJ1aWxkU25zVG9waWMoYGZhaWx1cmUtdG9waWMtJHtpZH1gLCAnRmFpbHVyZSBUb3BpYycpO1xuXG4gICAgICB0aGlzLmVycm9yVG9waWMgPSBmYWlsdXJlVG9waWM7XG4gICAgICB0aGlzLnN1Y2Nlc3NUb3BpYyA9IHN1Y2Nlc3NUb3BpYztcblxuICAgICAgLy8gY29uZmlndXJlIGFzeW5jIGluZmVyZW5jZVxuICAgICAgY29uc3QgYXN5bmNJbmZlcmVuY2VDb25maWdQcm9wZXJ0eTogc2FnZW1ha2VyLkNmbkVuZHBvaW50Q29uZmlnLkFzeW5jSW5mZXJlbmNlQ29uZmlnUHJvcGVydHkgPSB7XG4gICAgICAgIG91dHB1dENvbmZpZzoge1xuICAgICAgICAgIHMzRmFpbHVyZVBhdGg6IHByb3BzLmFzeW5jSW5mZXJlbmNlLmZhaWx1cmVQYXRoLFxuICAgICAgICAgIHMzT3V0cHV0UGF0aDogcHJvcHMuYXN5bmNJbmZlcmVuY2Uub3V0cHV0UGF0aCxcbiAgICAgICAgICBub3RpZmljYXRpb25Db25maWc6IHtcbiAgICAgICAgICAgIHN1Y2Nlc3NUb3BpYzogc3VjY2Vzc1RvcGljLnRvcGljQXJuLFxuICAgICAgICAgICAgZXJyb3JUb3BpYzogZmFpbHVyZVRvcGljLnRvcGljQXJuLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGNsaWVudENvbmZpZzoge1xuICAgICAgICAgIG1heENvbmN1cnJlbnRJbnZvY2F0aW9uc1Blckluc3RhbmNlOiBwcm9wcy5hc3luY0luZmVyZW5jZS5tYXhDb25jdXJyZW50SW52b2NhdGlvbnNQZXJJbnN0YW5jZSA/PyAxMCxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGVuZHBvaW50Q29uZmlnLmFzeW5jSW5mZXJlbmNlQ29uZmlnID0gYXN5bmNJbmZlcmVuY2VDb25maWdQcm9wZXJ0eTtcbiAgICB9XG5cbiAgICBlbmRwb2ludENvbmZpZy5hZGREZXBlbmRlbmN5KG1vZGVsKTtcblxuICAgIGNvbnN0IGVuZHBvaW50ID0gbmV3IHNhZ2VtYWtlci5DZm5FbmRwb2ludChzY29wZSwgYCR7bW9kZWxJZFN0cn0tZW5kcG9pbnQtJHtpZH1gLCB7XG4gICAgICBlbmRwb2ludE5hbWU6IHByb3BzLmVuZHBvaW50TmFtZSxcbiAgICAgIGVuZHBvaW50Q29uZmlnTmFtZTogZW5kcG9pbnRDb25maWcuZ2V0QXR0KCdFbmRwb2ludENvbmZpZ05hbWUnKS50b1N0cmluZygpLFxuICAgICAgdGFnczogW1xuICAgICAgICB7XG4gICAgICAgICAga2V5OiAnbW9kZWxJZCcsXG4gICAgICAgICAgdmFsdWU6IHRoaXMubW9kZWxJZCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBlbmRwb2ludC5hZGREZXBlbmRlbmN5KGVuZHBvaW50Q29uZmlnKTtcblxuXG4gICAgdGhpcy5jZm5Nb2RlbCA9IG1vZGVsO1xuICAgIHRoaXMuY2ZuRW5kcG9pbnQgPSBlbmRwb2ludDtcbiAgICB0aGlzLmNmbkVuZHBvaW50Q29uZmlnID0gZW5kcG9pbnRDb25maWc7XG4gICAgdGhpcy5lbmRwb2ludEFybiA9IGVuZHBvaW50LnJlZjtcbiAgICB0aGlzLnNjYWxpbmdQb2xpY3kgPSB0aGlzLmJ1aWxkU2NhbGluZ1BvbGljeShlbmRwb2ludCwgcHJvZHVjdGlvblZhcmlhbnQsIHByb3BzICk7XG4gIH1cblxuICBwdWJsaWMgYWRkVG9Sb2xlUG9saWN5KHN0YXRlbWVudDogaWFtLlBvbGljeVN0YXRlbWVudCkge1xuICAgIGlmICghdGhpcy5yb2xlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5yb2xlLmFkZFRvUG9saWN5KHN0YXRlbWVudCk7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRJbnZva2UoZ3JhbnRlZTogaWFtLklHcmFudGFibGUpOiBpYW0uR3JhbnQge1xuICAgIHJldHVybiBpYW0uR3JhbnQuYWRkVG9QcmluY2lwYWwoe1xuICAgICAgZ3JhbnRlZSxcbiAgICAgIGFjdGlvbnM6IFsnc2FnZW1ha2VyOkludm9rZUVuZHBvaW50J10sXG4gICAgICByZXNvdXJjZUFybnM6IFt0aGlzLmVuZHBvaW50QXJuXSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRTY2FsaW5nUG9saWN5KFxuICAgIGVuZHBvaW50OiBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnQsXG4gICAgcHJvZHVjdGlvblZhcmlhbnRzOiBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnRDb25maWcuUHJvZHVjdGlvblZhcmlhbnRQcm9wZXJ0eSxcbiAgICBwcm9wczogQ3VzdG9tU2FnZU1ha2VyRW5kcG9pbnRQcm9wcyk6IGFwcGxpY2F0aW9uYXV0b3NjYWxpbmcuU3RlcFNjYWxpbmdQb2xpY3kge1xuICAgIGNvbnN0IHJlc291cmNlSWQgPSBgZW5kcG9pbnQvJHtlbmRwb2ludC5hdHRyRW5kcG9pbnROYW1lfS92YXJpYW50LyR7cHJvZHVjdGlvblZhcmlhbnRzLnZhcmlhbnROYW1lfWA7XG5cbiAgICBjb25zdCBzY2FsYWJsZVRhcmdldCA9IG5ldyBhcHBsaWNhdGlvbmF1dG9zY2FsaW5nLlNjYWxhYmxlVGFyZ2V0KFxuICAgICAgdGhpcyxcbiAgICAgICdTY2FsYWJsZVRhcmdldCcsXG4gICAgICB7XG4gICAgICAgIHNlcnZpY2VOYW1lc3BhY2U6IGFwcGxpY2F0aW9uYXV0b3NjYWxpbmcuU2VydmljZU5hbWVzcGFjZS5TQUdFTUFLRVIsXG4gICAgICAgIHJlc291cmNlSWQ6IHJlc291cmNlSWQsXG4gICAgICAgIHNjYWxhYmxlRGltZW5zaW9uOiAnc2FnZW1ha2VyOnZhcmlhbnQ6RGVzaXJlZEluc3RhbmNlQ291bnQnLFxuICAgICAgICBtaW5DYXBhY2l0eTogcHJvcHMubWluQ2FwYWNpdHkgPz8gMSxcbiAgICAgICAgbWF4Q2FwYWNpdHk6IHByb3BzLm1heENhcGFjaXR5ID8/IDIsXG4gICAgICB9LFxuICAgICk7XG4gICAgc2NhbGFibGVUYXJnZXQubm9kZS5hZGREZXBlbmRlbmN5KGVuZHBvaW50KTtcblxuICAgIGNvbnN0IGFwcHJveGltYXRlQmFja2xvZ01ldHJpYyA9IG5ldyBjZGsuYXdzX2Nsb3Vkd2F0Y2guTWV0cmljKHtcbiAgICAgIG5hbWVzcGFjZTogJ0FXUy9TYWdlTWFrZXInLFxuICAgICAgbWV0cmljTmFtZTogJ0FwcHJveGltYXRlQmFja2xvZ1NpemVQZXJJbnN0YW5jZScsXG4gICAgICBkaW1lbnNpb25zTWFwOiB7XG4gICAgICAgIEVuZHBvaW50OiBlbmRwb2ludC5hdHRyRW5kcG9pbnROYW1lLFxuICAgICAgICBWYXJpYW50OiBwcm9kdWN0aW9uVmFyaWFudHMudmFyaWFudE5hbWUsXG4gICAgICB9LFxuICAgICAgc3RhdGlzdGljOiAnQXZlcmFnZScsXG4gICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2NhbGluZ1BvbGljeSA9IG5ldyBhcHBsaWNhdGlvbmF1dG9zY2FsaW5nLlN0ZXBTY2FsaW5nUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgICdTY2FsaW5nUG9saWN5JyxcbiAgICAgIHtcbiAgICAgICAgc2NhbGluZ1RhcmdldDogc2NhbGFibGVUYXJnZXQsXG4gICAgICAgIGFkanVzdG1lbnRUeXBlOiBhcHBsaWNhdGlvbmF1dG9zY2FsaW5nLkFkanVzdG1lbnRUeXBlLkNIQU5HRV9JTl9DQVBBQ0lUWSxcbiAgICAgICAgbWV0cmljOiBhcHByb3hpbWF0ZUJhY2tsb2dNZXRyaWMsXG4gICAgICAgIHNjYWxpbmdTdGVwczogW1xuICAgICAgICAgIHsgdXBwZXI6IDAsIGNoYW5nZTogLTEsIGxvd2VyOiAwIH0sXG4gICAgICAgICAgeyBjaGFuZ2U6IDEsIGxvd2VyOiAwLjUgfSxcbiAgICAgICAgXSxcbiAgICAgICAgY29vbGRvd246IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxuICAgICAgICBkYXRhcG9pbnRzVG9BbGFybTogMSxcbiAgICAgICAgZXZhbHVhdGlvblBlcmlvZHM6IDEsXG4gICAgICB9LFxuICAgICk7XG5cbiAgICByZXR1cm4gc2NhbGluZ1BvbGljeTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRTbnNUb3BpYyh0b3BpY05hbWU6IHN0cmluZywgZGlzcGxheU5hbWU6IHN0cmluZyk6IHNucy5Ub3BpYyB7XG4gICAgY29uc3QgbWFzdGVyS2V5ID0ga21zLkFsaWFzLmZyb21BbGlhc05hbWUodGhpcywgYGF3cy1tYW5hZ2VkLWtleS0ke3RvcGljTmFtZX1gLCAnYWxpYXMvYXdzL3NucycpO1xuXG4gICAgY29uc3QgdG9waWMgPSBuZXcgc25zLlRvcGljKHRoaXMsIHRvcGljTmFtZSwge1xuICAgICAgdG9waWNOYW1lLFxuICAgICAgZGlzcGxheU5hbWUsXG4gICAgICBtYXN0ZXJLZXk6IG1hc3RlcktleSxcbiAgICB9KTtcblxuICAgIHRvcGljLmdyYW50UHVibGlzaCh0aGlzLnJvbGUpO1xuXG4gICAgdG9waWMuYWRkVG9SZXNvdXJjZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICBhY3Rpb25zOiBbJ3NuczpQdWJsaXNoJ10sXG4gICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuREVOWSxcbiAgICAgIHJlc291cmNlczogW3RvcGljLnRvcGljQXJuXSxcbiAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgQm9vbDoge1xuICAgICAgICAgICdhd3M6U2VjdXJlVHJhbnNwb3J0JzogJ2ZhbHNlJyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBwcmluY2lwYWxzOiBbbmV3IGlhbS5BbnlQcmluY2lwYWwoKV0sXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHRvcGljO1xuICB9XG59Il19