"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.download_data = exports.generateJumpStartModels = void 0;
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const fs = require("fs");
const path = require("path");
const zlib = require("zlib");
const generate_utils_1 = require("./generate-utils");
const jumpstart_constants_1 = require("../private/jumpstart-constants");
const JUMPSTART_CACHE_PATH = path.join(__dirname, './.cache/jumpstart-models-cache.json');
const JUMPSTART_MODEL_PATH = path.join(__dirname, '../jumpstart-model.ts');
const JUMPSTART_MODELS_PATH = path.join(__dirname, '../jumpstart-models.json');
const ALLOWED_FRAMEWORKS = [
    'huggingface',
    'huggingface-llm',
    'djl-deepspeed',
    'djl-fastertransformer',
    'stabilityai',
];
async function generateJumpStartModels() {
    console.log('Getting JumpStart models data');
    await download_data();
    generateCode();
}
exports.generateJumpStartModels = generateJumpStartModels;
async function download_data() {
    console.log('Downloading JumpStart models data');
    const regions = jumpstart_constants_1.JumpStartConstants.JUMPSTART_LAUNCHED_REGIONS;
    const regionNames = Object.keys(regions).filter((c) => c === 'us-east-1');
    const models = {};
    const frameworks = new Set();
    for (const regionName of regionNames) {
        console.log(`Processing region ${regionName}`);
        const regionData = regions[regionName];
        const manifestS3Key = jumpstart_constants_1.JumpStartConstants.JUMPSTART_DEFAULT_MANIFEST_FILE_S3_KEY;
        const url = `https://${regionData.contentBucket}.s3.${regionName}.amazonaws.com/${manifestS3Key}`;
        const [manifest] = await generate_utils_1.GenerateUtils.downloadJSON(url);
        for (const model of manifest) {
            const specUrl = `https://${regionData.contentBucket}.s3.${regionName}.amazonaws.com/${model.spec_key}`;
            const [modelSpec] = await generate_utils_1.GenerateUtils.downloadJSON(specUrl);
            const { deprecated, hosting_ecr_specs, default_inference_instance_type, supported_inference_instance_types, hosting_model_package_arns, hosting_use_script_uri, hosting_script_key, hosting_artifact_key, hosting_prepacked_artifact_key, gated_bucket, inference_environment_variables, hosting_instance_type_variants, hosting_eula_key, } = modelSpec;
            const allowedFramework = ALLOWED_FRAMEWORKS.includes(hosting_ecr_specs.framework);
            console.log(`${deprecated ? '[DEPRECATED] ' : ''}${!allowedFramework ? '[SKIP:' + hosting_ecr_specs.framework + '] ' : ''}${model.model_id}/${model.version}`);
            frameworks.add(hosting_ecr_specs.framework);
            if (deprecated)
                continue;
            if (!ALLOWED_FRAMEWORKS.includes(hosting_ecr_specs.framework))
                continue;
            if (hosting_use_script_uri ||
                (!hosting_prepacked_artifact_key && !hosting_model_package_arns && !hosting_artifact_key)) {
                throw new Error('No model data');
            }
            models[model.model_id] = models[model.model_id] ?? {};
            models[model.model_id][model.version] = models[model.model_id][model.version] ?? {};
            models[model.model_id][model.version] = {
                deprecated,
                hosting_ecr_specs,
                default_inference_instance_type,
                supported_inference_instance_types,
                hosting_model_package_arns,
                hosting_use_script_uri,
                hosting_artifact_key,
                hosting_script_key,
                hosting_prepacked_artifact_key,
                gated_bucket,
                inference_environment_variables,
                hosting_instance_type_variants,
                hosting_eula_key,
            };
        }
    }
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(JUMPSTART_CACHE_PATH, JSON.stringify(models));
    console.log('Frameworks', Array.from(frameworks));
}
exports.download_data = download_data;
function generateCode() {
    console.log('Generating JumpStart models data');
    const data = JSON.parse(fs.readFileSync(JUMPSTART_CACHE_PATH, 'utf8'));
    let modelsStr = '';
    let specs = {};
    for (const modelId of Object.keys(data)) {
        for (const version of Object.keys(data[modelId])) {
            const modelName = `${generate_utils_1.GenerateUtils.replaceAll(modelId, '-', '_')}_${generate_utils_1.GenerateUtils.replaceAll(version, '\\.', '_')}`.toUpperCase();
            const specSource = data[modelId][version];
            const environment = {};
            for (const env of specSource.inference_environment_variables) {
                environment[env.name] = env.default;
            }
            const hosting_eula_key = specSource.hosting_eula_key;
            const instanceVariants = specSource.hosting_instance_type_variants?.variants;
            const instanceAliases = specSource.hosting_instance_type_variants?.regional_aliases;
            let instanceVariantsArr;
            let instanceAliasesArr;
            if (instanceVariants) {
                instanceVariantsArr = [];
                for (const instanceType of Object.keys(instanceVariants)) {
                    const current = instanceVariants[instanceType];
                    instanceVariantsArr.push({
                        instanceType,
                        imageUri: current.regional_properties?.image_uri,
                        environment: current.properties?.environment_variables,
                    });
                }
            }
            if (instanceAliases) {
                instanceAliasesArr = [];
                for (const region of Object.keys(instanceAliases)) {
                    const current = instanceAliases[region];
                    instanceAliasesArr.push({
                        region,
                        aliases: current,
                    });
                }
            }
            const spec = {
                modelId,
                version,
                defaultInstanceType: specSource.default_inference_instance_type,
                instanceTypes: specSource.supported_inference_instance_types,
                modelPackageArns: specSource.hosting_model_package_arns,
                prepackedArtifactKey: specSource.hosting_prepacked_artifact_key,
                gatedBucket: specSource.gated_bucket,
                artifactKey: specSource.hosting_artifact_key,
                environment,
                instanceAliases: instanceAliasesArr,
                instanceVariants: instanceVariantsArr,
                requiresEula: hosting_eula_key,
            };
            if (spec.modelPackageArns) {
                delete spec.artifactKey;
                delete spec.prepackedArtifactKey;
            }
            specs[modelName] = spec;
            modelsStr += '  ' + `public static readonly ${modelName} = this.of('${modelName}');\n`;
        }
    }
    const fileStr = `/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
import * as zlib from 'zlib';
import * as data from './jumpstart-models.json';

export interface IInstanceAliase {
  region: string;
  aliases: { [key: string]: string };
}

export interface IInstanceValiant {
  instanceType: string;
  imageUri?: string;
  environment?: { [key: string]: string };
}

export interface IJumpStartModelSpec {
  modelId: string;
  version: string;
  defaultInstanceType: string;
  instanceTypes: string[];
  modelPackageArns?: { [region: string]: string };
  prepackedArtifactKey?: string;
  gatedBucket: boolean;
  artifactKey?: string;
  environment: { [key: string]: string | number | boolean };
  instanceAliases?: IInstanceAliase[];
  instanceVariants?: IInstanceValiant[];
  requiresEula: boolean;
}

export class JumpStartModel {
${modelsStr}

  public static of(name: string): JumpStartModel {
    return new JumpStartModel(name);
  }

  constructor(private readonly name: string) {}

  public bind(): IJumpStartModelSpec {
    const bufferSource = (data as { data: number[] }).data;
    const buffer = Buffer.from(bufferSource);
    const bufferStr = zlib.inflateRawSync(buffer);
    const json = JSON.parse(bufferStr.toString());

    return json[this.name];
  }
}`;
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(JUMPSTART_MODELS_PATH, JSON.stringify(zlib.deflateRawSync(JSON.stringify(specs)).toJSON()));
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(JUMPSTART_MODEL_PATH, fileStr);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtanVtcHN0YXJ0LW1vZGVscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9wYXR0ZXJucy9nZW4tYWkvYXdzLW1vZGVsLWRlcGxveW1lbnQtc2FnZW1ha2VyL2NvZGUtZ2VuZXJhdGlvbi9nZW5lcmF0ZS1qdW1wc3RhcnQtbW9kZWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBQ0gseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3Qiw2QkFBNkI7QUFDN0IscURBQWlEO0FBQ2pELHdFQUFvRTtBQW9EcEUsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxzQ0FBc0MsQ0FBQyxDQUFDO0FBQzFGLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztBQUMzRSxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLDBCQUEwQixDQUFDLENBQUM7QUFFL0UsTUFBTSxrQkFBa0IsR0FBRztJQUN6QixhQUFhO0lBQ2IsaUJBQWlCO0lBQ2pCLGVBQWU7SUFDZix1QkFBdUI7SUFDdkIsYUFBYTtDQUNkLENBQUM7QUFFSyxLQUFLLFVBQVUsdUJBQXVCO0lBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUU3QyxNQUFNLGFBQWEsRUFBRSxDQUFDO0lBQ3RCLFlBQVksRUFBRSxDQUFDO0FBQ2pCLENBQUM7QUFMRCwwREFLQztBQUVNLEtBQUssVUFBVSxhQUFhO0lBQ2pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLENBQUMsQ0FBQztJQUVqRCxNQUFNLE9BQU8sR0FBRyx3Q0FBa0IsQ0FBQywwQkFBMEIsQ0FBQztJQUM5RCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFD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LENBQUMscUJBQXFCLENBQUMsb0JBQW9CLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDckUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgemxpYiBmcm9tICd6bGliJztcbmltcG9ydCB7IEdlbmVyYXRlVXRpbHMgfSBmcm9tICcuL2dlbmVyYXRlLXV0aWxzJztcbmltcG9ydCB7IEp1bXBTdGFydENvbnN0YW50cyB9IGZyb20gJy4uL3ByaXZhdGUvanVtcHN0YXJ0LWNvbnN0YW50cyc7XG5cbmludGVyZmFjZSBKdW1wU3RhcnRNb2RlbE1hbmlmZXN0IHtcbiAgbW9kZWxfaWQ6IHN0cmluZztcbiAgdmVyc2lvbjogc3RyaW5nO1xuICBzcGVjX2tleTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSnVtcFN0YXJ0TW9kZWxTcGVjIHtcbiAgZGVwcmVjYXRlZDogYm9vbGVhbjtcbiAgaG9zdGluZ19lY3Jfc3BlY3M6IHtcbiAgICBmcmFtZXdvcms6IHN0cmluZztcbiAgfTtcbiAgZGVmYXVsdF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZTogc3RyaW5nO1xuICBzdXBwb3J0ZWRfaW5mZXJlbmNlX2luc3RhbmNlX3R5cGVzOiBzdHJpbmdbXTtcbiAgaG9zdGluZ19tb2RlbF9wYWNrYWdlX2FybnM/OiB7IFtyZWdpb246IHN0cmluZ106IHN0cmluZyB9O1xuICBob3N0aW5nX3VzZV9zY3JpcHRfdXJpOiBzdHJpbmc7XG4gIGhvc3RpbmdfYXJ0aWZhY3Rfa2V5Pzogc3RyaW5nO1xuICBob3N0aW5nX3NjcmlwdF9rZXk/OiBzdHJpbmc7XG4gIGhvc3RpbmdfcHJlcGFja2VkX2FydGlmYWN0X2tleT86IHN0cmluZztcbiAgZ2F0ZWRfYnVja2V0OiBib29sZWFuO1xuICBob3N0aW5nX2V1bGFfa2V5Pzogc3RyaW5nO1xuICBpbmZlcmVuY2VfZW52aXJvbm1lbnRfdmFyaWFibGVzOiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBkZWZhdWx0OiBzdHJpbmc7XG4gICAgc2NvcGU6IHN0cmluZztcbiAgICByZXF1aXJlZF9mb3JfbW9kZWxfY2xhc3M6IGJvb2xlYW47XG4gIH1bXTtcbiAgaG9zdGluZ19pbnN0YW5jZV90eXBlX3ZhcmlhbnRzPzoge1xuICAgIHJlZ2lvbmFsX2FsaWFzZXM/OiB7IFtyZWdpb246IHN0cmluZ106IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gfTtcbiAgICB2YXJpYW50czoge1xuICAgICAgW2tleTogc3RyaW5nXToge1xuICAgICAgICByZWdpb25hbF9wcm9wZXJ0aWVzPzoge1xuICAgICAgICAgIGltYWdlX3VyaTogc3RyaW5nO1xuICAgICAgICB9O1xuICAgICAgICBwcm9wZXJ0aWVzPzoge1xuICAgICAgICAgIGVudmlyb25tZW50X3ZhcmlhYmxlczoge1xuICAgICAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgICB9O1xuICAgIH07XG4gIH07XG59XG5cbmludGVyZmFjZSBNb2RlbHNEYXRhIHtcbiAgW21vZGVsSWQ6IHN0cmluZ106IHtcbiAgICBbdmVyc2lvbjogc3RyaW5nXTogSnVtcFN0YXJ0TW9kZWxTcGVjO1xuICB9O1xufVxuXG5jb25zdCBKVU1QU1RBUlRfQ0FDSEVfUEFUSCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLy5jYWNoZS9qdW1wc3RhcnQtbW9kZWxzLWNhY2hlLmpzb24nKTtcbmNvbnN0IEpVTVBTVEFSVF9NT0RFTF9QQVRIID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2p1bXBzdGFydC1tb2RlbC50cycpO1xuY29uc3QgSlVNUFNUQVJUX01PREVMU19QQVRIID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2p1bXBzdGFydC1tb2RlbHMuanNvbicpO1xuXG5jb25zdCBBTExPV0VEX0ZSQU1FV09SS1MgPSBbXG4gICdodWdnaW5nZmFjZScsXG4gICdodWdnaW5nZmFjZS1sbG0nLFxuICAnZGpsLWRlZXBzcGVlZCcsXG4gICdkamwtZmFzdGVydHJhbnNmb3JtZXInLFxuICAnc3RhYmlsaXR5YWknLFxuXTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlSnVtcFN0YXJ0TW9kZWxzKCkge1xuICBjb25zb2xlLmxvZygnR2V0dGluZyBKdW1wU3RhcnQgbW9kZWxzIGRhdGEnKTtcblxuICBhd2FpdCBkb3dubG9hZF9kYXRhKCk7XG4gIGdlbmVyYXRlQ29kZSgpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRfZGF0YSgpIHtcbiAgY29uc29sZS5sb2coJ0Rvd25sb2FkaW5nIEp1bXBTdGFydCBtb2RlbHMgZGF0YScpO1xuXG4gIGNvbnN0IHJlZ2lvbnMgPSBKdW1wU3RhcnRDb25zdGFudHMuSlVNUFNUQVJUX0xBVU5DSEVEX1JFR0lPTlM7XG4gIGNvbnN0IHJlZ2lvbk5hbWVzID0gT2JqZWN0LmtleXMocmVnaW9ucykuZmlsdGVyKChjKSA9PiBjID09PSAndXMtZWFzdC0xJyk7XG4gIGNvbnN0IG1vZGVsczogTW9kZWxzRGF0YSA9IHt9O1xuICBjb25zdCBmcmFtZXdvcmtzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgZm9yIChjb25zdCByZWdpb25OYW1lIG9mIHJlZ2lvbk5hbWVzKSB7XG4gICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgcmVnaW9uICR7cmVnaW9uTmFtZX1gKTtcbiAgICBjb25zdCByZWdpb25EYXRhID0gcmVnaW9uc1tyZWdpb25OYW1lXTtcbiAgICBjb25zdCBtYW5pZmVzdFMzS2V5ID0gSnVtcFN0YXJ0Q29uc3RhbnRzLkpVTVBTVEFSVF9ERUZBVUxUX01BTklGRVNUX0ZJTEVfUzNfS0VZO1xuICAgIGNvbnN0IHVybCA9IGBodHRwczovLyR7cmVnaW9uRGF0YS5jb250ZW50QnVja2V0fS5zMy4ke3JlZ2lvbk5hbWV9LmFtYXpvbmF3cy5jb20vJHttYW5pZmVzdFMzS2V5fWA7XG4gICAgY29uc3QgW21hbmlmZXN0XTogW0p1bXBTdGFydE1vZGVsTWFuaWZlc3RbXV0gPSBhd2FpdCBHZW5lcmF0ZVV0aWxzLmRvd25sb2FkSlNPTih1cmwpO1xuXG4gICAgZm9yIChjb25zdCBtb2RlbCBvZiBtYW5pZmVzdCkge1xuICAgICAgY29uc3Qgc3BlY1VybCA9IGBodHRwczovLyR7cmVnaW9uRGF0YS5jb250ZW50QnVja2V0fS5zMy4ke3JlZ2lvbk5hbWV9LmFtYXpvbmF3cy5jb20vJHttb2RlbC5zcGVjX2tleX1gO1xuICAgICAgY29uc3QgW21vZGVsU3BlY106IFtKdW1wU3RhcnRNb2RlbFNwZWNdID0gYXdhaXQgR2VuZXJhdGVVdGlscy5kb3dubG9hZEpTT04oc3BlY1VybCk7XG5cbiAgICAgIGNvbnN0IHtcbiAgICAgICAgZGVwcmVjYXRlZCxcbiAgICAgICAgaG9zdGluZ19lY3Jfc3BlY3MsXG4gICAgICAgIGRlZmF1bHRfaW5mZXJlbmNlX2luc3RhbmNlX3R5cGUsXG4gICAgICAgIHN1cHBvcnRlZF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZXMsXG4gICAgICAgIGhvc3RpbmdfbW9kZWxfcGFja2FnZV9hcm5zLFxuICAgICAgICBob3N0aW5nX3VzZV9zY3JpcHRfdXJpLFxuICAgICAgICBob3N0aW5nX3NjcmlwdF9rZXksXG4gICAgICAgIGhvc3RpbmdfYXJ0aWZhY3Rfa2V5LFxuICAgICAgICBob3N0aW5nX3ByZXBhY2tlZF9hcnRpZmFjdF9rZXksXG4gICAgICAgIGdhdGVkX2J1Y2tldCxcbiAgICAgICAgaW5mZXJlbmNlX2Vudmlyb25tZW50X3ZhcmlhYmxlcyxcbiAgICAgICAgaG9zdGluZ19pbnN0YW5jZV90eXBlX3ZhcmlhbnRzLFxuICAgICAgICBob3N0aW5nX2V1bGFfa2V5LFxuICAgICAgfSA9IG1vZGVsU3BlYztcblxuICAgICAgY29uc3QgYWxsb3dlZEZyYW1ld29yayA9IEFMTE9XRURfRlJBTUVXT1JLUy5pbmNsdWRlcyhob3N0aW5nX2Vjcl9zcGVjcy5mcmFtZXdvcmspO1xuXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYCR7ZGVwcmVjYXRlZCA/ICdbREVQUkVDQVRFRF0gJyA6ICcnfSR7XG4gICAgICAgICAgIWFsbG93ZWRGcmFtZXdvcmsgPyAnW1NLSVA6JyArIGhvc3RpbmdfZWNyX3NwZWNzLmZyYW1ld29yayArICddICcgOiAnJ1xuICAgICAgICB9JHttb2RlbC5tb2RlbF9pZH0vJHttb2RlbC52ZXJzaW9ufWAsXG4gICAgICApO1xuXG4gICAgICBmcmFtZXdvcmtzLmFkZChob3N0aW5nX2Vjcl9zcGVjcy5mcmFtZXdvcmspO1xuICAgICAgaWYgKGRlcHJlY2F0ZWQpIGNvbnRpbnVlO1xuICAgICAgaWYgKCFBTExPV0VEX0ZSQU1FV09SS1MuaW5jbHVkZXMoaG9zdGluZ19lY3Jfc3BlY3MuZnJhbWV3b3JrKSkgY29udGludWU7XG4gICAgICBpZiAoXG4gICAgICAgIGhvc3RpbmdfdXNlX3NjcmlwdF91cmkgfHxcbiAgICAgICAgKCFob3N0aW5nX3ByZXBhY2tlZF9hcnRpZmFjdF9rZXkgJiYgIWhvc3RpbmdfbW9kZWxfcGFja2FnZV9hcm5zICYmICFob3N0aW5nX2FydGlmYWN0X2tleSlcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIG1vZGVsIGRhdGEnKTtcbiAgICAgIH1cblxuICAgICAgbW9kZWxzW21vZGVsLm1vZGVsX2lkXSA9IG1vZGVsc1ttb2RlbC5tb2RlbF9pZF0gPz8ge307XG4gICAgICBtb2RlbHNbbW9kZWwubW9kZWxfaWRdW21vZGVsLnZlcnNpb25dID0gbW9kZWxzW21vZGVsLm1vZGVsX2lkXVttb2RlbC52ZXJzaW9uXSA/PyB7fTtcblxuICAgICAgbW9kZWxzW21vZGVsLm1vZGVsX2lkXVttb2RlbC52ZXJzaW9uXSA9IHtcbiAgICAgICAgZGVwcmVjYXRlZCxcbiAgICAgICAgaG9zdGluZ19lY3Jfc3BlY3MsXG4gICAgICAgIGRlZmF1bHRfaW5mZXJlbmNlX2luc3RhbmNlX3R5cGUsXG4gICAgICAgIHN1cHBvcnRlZF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZXMsXG4gICAgICAgIGhvc3RpbmdfbW9kZWxfcGFja2FnZV9hcm5zLFxuICAgICAgICBob3N0aW5nX3VzZV9zY3JpcHRfdXJpLFxuICAgICAgICBob3N0aW5nX2FydGlmYWN0X2tleSxcbiAgICAgICAgaG9zdGluZ19zY3JpcHRfa2V5LFxuICAgICAgICBob3N0aW5nX3ByZXBhY2tlZF9hcnRpZmFjdF9rZXksXG4gICAgICAgIGdhdGVkX2J1Y2tldCxcbiAgICAgICAgaW5mZXJlbmNlX2Vudmlyb25tZW50X3ZhcmlhYmxlcyxcbiAgICAgICAgaG9zdGluZ19pbnN0YW5jZV90eXBlX3ZhcmlhbnRzLFxuICAgICAgICBob3N0aW5nX2V1bGFfa2V5LFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBHZW5lcmF0ZVV0aWxzLndyaXRlRmlsZVN5bmNXaXRoRGlycyhKVU1QU1RBUlRfQ0FDSEVfUEFUSCwgSlNPTi5zdHJpbmdpZnkobW9kZWxzKSk7XG5cbiAgY29uc29sZS5sb2coJ0ZyYW1ld29ya3MnLCBBcnJheS5mcm9tKGZyYW1ld29ya3MpKTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVDb2RlKCkge1xuICBjb25zb2xlLmxvZygnR2VuZXJhdGluZyBKdW1wU3RhcnQgbW9kZWxzIGRhdGEnKTtcblxuICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoSlVNUFNUQVJUX0NBQ0hFX1BBVEgsICd1dGY4JykpO1xuXG4gIGxldCBtb2RlbHNTdHIgPSAnJztcbiAgbGV0IHNwZWNzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgZm9yIChjb25zdCBtb2RlbElkIG9mIE9iamVjdC5rZXlzKGRhdGEpKSB7XG4gICAgZm9yIChjb25zdCB2ZXJzaW9uIG9mIE9iamVjdC5rZXlzKGRhdGFbbW9kZWxJZF0pKSB7XG4gICAgICBjb25zdCBtb2RlbE5hbWUgPSBgJHtHZW5lcmF0ZVV0aWxzLnJlcGxhY2VBbGwobW9kZWxJZCwgJy0nLCAnXycpfV8ke0dlbmVyYXRlVXRpbHMucmVwbGFjZUFsbChcbiAgICAgICAgdmVyc2lvbixcbiAgICAgICAgJ1xcXFwuJyxcbiAgICAgICAgJ18nLFxuICAgICAgKX1gLnRvVXBwZXJDYXNlKCk7XG5cbiAgICAgIGNvbnN0IHNwZWNTb3VyY2UgPSBkYXRhW21vZGVsSWRdW3ZlcnNpb25dO1xuICAgICAgY29uc3QgZW52aXJvbm1lbnQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB9ID0ge307XG4gICAgICBmb3IgKGNvbnN0IGVudiBvZiBzcGVjU291cmNlLmluZmVyZW5jZV9lbnZpcm9ubWVudF92YXJpYWJsZXMpIHtcbiAgICAgICAgZW52aXJvbm1lbnRbZW52Lm5hbWVdID0gZW52LmRlZmF1bHQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGhvc3RpbmdfZXVsYV9rZXkgPSBzcGVjU291cmNlLmhvc3RpbmdfZXVsYV9rZXk7XG4gICAgICBjb25zdCBpbnN0YW5jZVZhcmlhbnRzID0gc3BlY1NvdXJjZS5ob3N0aW5nX2luc3RhbmNlX3R5cGVfdmFyaWFudHM/LnZhcmlhbnRzO1xuICAgICAgY29uc3QgaW5zdGFuY2VBbGlhc2VzID0gc3BlY1NvdXJjZS5ob3N0aW5nX2luc3RhbmNlX3R5cGVfdmFyaWFudHM/LnJlZ2lvbmFsX2FsaWFzZXM7XG4gICAgICBsZXQgaW5zdGFuY2VWYXJpYW50c0FycjogYW55W10gfCB1bmRlZmluZWQ7XG4gICAgICBsZXQgaW5zdGFuY2VBbGlhc2VzQXJyOiBhbnlbXSB8IHVuZGVmaW5lZDtcbiAgICAgIGlmIChpbnN0YW5jZVZhcmlhbnRzKSB7XG4gICAgICAgIGluc3RhbmNlVmFyaWFudHNBcnIgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBpbnN0YW5jZVR5cGUgb2YgT2JqZWN0LmtleXMoaW5zdGFuY2VWYXJpYW50cykpIHtcbiAgICAgICAgICBjb25zdCBjdXJyZW50ID0gaW5zdGFuY2VWYXJpYW50c1tpbnN0YW5jZVR5cGVdO1xuXG4gICAgICAgICAgaW5zdGFuY2VWYXJpYW50c0Fyci5wdXNoKHtcbiAgICAgICAgICAgIGluc3RhbmNlVHlwZSxcbiAgICAgICAgICAgIGltYWdlVXJpOiBjdXJyZW50LnJlZ2lvbmFsX3Byb3BlcnRpZXM/LmltYWdlX3VyaSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiBjdXJyZW50LnByb3BlcnRpZXM/LmVudmlyb25tZW50X3ZhcmlhYmxlcyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoaW5zdGFuY2VBbGlhc2VzKSB7XG4gICAgICAgIGluc3RhbmNlQWxpYXNlc0FyciA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHJlZ2lvbiBvZiBPYmplY3Qua2V5cyhpbnN0YW5jZUFsaWFzZXMpKSB7XG4gICAgICAgICAgY29uc3QgY3VycmVudCA9IGluc3RhbmNlQWxpYXNlc1tyZWdpb25dO1xuXG4gICAgICAgICAgaW5zdGFuY2VBbGlhc2VzQXJyLnB1c2goe1xuICAgICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgICAgYWxpYXNlczogY3VycmVudCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBzcGVjID0ge1xuICAgICAgICBtb2RlbElkLFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICBkZWZhdWx0SW5zdGFuY2VUeXBlOiBzcGVjU291cmNlLmRlZmF1bHRfaW5mZXJlbmNlX2luc3RhbmNlX3R5cGUsXG4gICAgICAgIGluc3RhbmNlVHlwZXM6IHNwZWNTb3VyY2Uuc3VwcG9ydGVkX2luZmVyZW5jZV9pbnN0YW5jZV90eXBlcyxcbiAgICAgICAgbW9kZWxQYWNrYWdlQXJuczogc3BlY1NvdXJjZS5ob3N0aW5nX21vZGVsX3BhY2thZ2VfYXJucyxcbiAgICAgICAgcHJlcGFja2VkQXJ0aWZhY3RLZXk6IHNwZWNTb3VyY2UuaG9zdGluZ19wcmVwYWNrZWRfYXJ0aWZhY3Rfa2V5LFxuICAgICAgICBnYXRlZEJ1Y2tldDogc3BlY1NvdXJjZS5nYXRlZF9idWNrZXQsXG4gICAgICAgIGFydGlmYWN0S2V5OiBzcGVjU291cmNlLmhvc3RpbmdfYXJ0aWZhY3Rfa2V5LFxuICAgICAgICBlbnZpcm9ubWVudCxcbiAgICAgICAgaW5zdGFuY2VBbGlhc2VzOiBpbnN0YW5jZUFsaWFzZXNBcnIsXG4gICAgICAgIGluc3RhbmNlVmFyaWFudHM6IGluc3RhbmNlVmFyaWFudHNBcnIsXG4gICAgICAgIHJlcXVpcmVzRXVsYTogaG9zdGluZ19ldWxhX2tleSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChzcGVjLm1vZGVsUGFja2FnZUFybnMpIHtcbiAgICAgICAgZGVsZXRlIHNwZWMuYXJ0aWZhY3RLZXk7XG4gICAgICAgIGRlbGV0ZSBzcGVjLnByZXBhY2tlZEFydGlmYWN0S2V5O1xuICAgICAgfVxuXG4gICAgICBzcGVjc1ttb2RlbE5hbWVdID0gc3BlYztcbiAgICAgIG1vZGVsc1N0ciArPSAnICAnICsgYHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgJHttb2RlbE5hbWV9ID0gdGhpcy5vZignJHttb2RlbE5hbWV9Jyk7XFxuYDtcbiAgICB9XG4gIH1cblxuICBjb25zdCBmaWxlU3RyID0gYC8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5pbXBvcnQgKiBhcyB6bGliIGZyb20gJ3psaWInO1xuaW1wb3J0ICogYXMgZGF0YSBmcm9tICcuL2p1bXBzdGFydC1tb2RlbHMuanNvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUluc3RhbmNlQWxpYXNlIHtcbiAgcmVnaW9uOiBzdHJpbmc7XG4gIGFsaWFzZXM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUluc3RhbmNlVmFsaWFudCB7XG4gIGluc3RhbmNlVHlwZTogc3RyaW5nO1xuICBpbWFnZVVyaT86IHN0cmluZztcbiAgZW52aXJvbm1lbnQ/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElKdW1wU3RhcnRNb2RlbFNwZWMge1xuICBtb2RlbElkOiBzdHJpbmc7XG4gIHZlcnNpb246IHN0cmluZztcbiAgZGVmYXVsdEluc3RhbmNlVHlwZTogc3RyaW5nO1xuICBpbnN0YW5jZVR5cGVzOiBzdHJpbmdbXTtcbiAgbW9kZWxQYWNrYWdlQXJucz86IHsgW3JlZ2lvbjogc3RyaW5nXTogc3RyaW5nIH07XG4gIHByZXBhY2tlZEFydGlmYWN0S2V5Pzogc3RyaW5nO1xuICBnYXRlZEJ1Y2tldDogYm9vbGVhbjtcbiAgYXJ0aWZhY3RLZXk/OiBzdHJpbmc7XG4gIGVudmlyb25tZW50OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfTtcbiAgaW5zdGFuY2VBbGlhc2VzPzogSUluc3RhbmNlQWxpYXNlW107XG4gIGluc3RhbmNlVmFyaWFudHM/OiBJSW5zdGFuY2VWYWxpYW50W107XG4gIHJlcXVpcmVzRXVsYTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEp1bXBTdGFydE1vZGVsIHtcbiR7bW9kZWxzU3RyfVxuXG4gIHB1YmxpYyBzdGF0aWMgb2YobmFtZTogc3RyaW5nKTogSnVtcFN0YXJ0TW9kZWwge1xuICAgIHJldHVybiBuZXcgSnVtcFN0YXJ0TW9kZWwobmFtZSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZykge31cblxuICBwdWJsaWMgYmluZCgpOiBJSnVtcFN0YXJ0TW9kZWxTcGVjIHtcbiAgICBjb25zdCBidWZmZXJTb3VyY2UgPSAoZGF0YSBhcyB7IGRhdGE6IG51bWJlcltdIH0pLmRhdGE7XG4gICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oYnVmZmVyU291cmNlKTtcbiAgICBjb25zdCBidWZmZXJTdHIgPSB6bGliLmluZmxhdGVSYXdTeW5jKGJ1ZmZlcik7XG4gICAgY29uc3QganNvbiA9IEpTT04ucGFyc2UoYnVmZmVyU3RyLnRvU3RyaW5nKCkpO1xuXG4gICAgcmV0dXJuIGpzb25bdGhpcy5uYW1lXTtcbiAgfVxufWA7XG5cbiAgR2VuZXJhdGVVdGlscy53cml0ZUZpbGVTeW5jV2l0aERpcnMoXG4gICAgSlVNUFNUQVJUX01PREVMU19QQVRILFxuICAgIEpTT04uc3RyaW5naWZ5KHpsaWIuZGVmbGF0ZVJhd1N5bmMoSlNPTi5zdHJpbmdpZnkoc3BlY3MpKS50b0pTT04oKSksXG4gICk7XG4gIEdlbmVyYXRlVXRpbHMud3JpdGVGaWxlU3luY1dpdGhEaXJzKEpVTVBTVEFSVF9NT0RFTF9QQVRILCBmaWxlU3RyKTtcbn1cbiJdfQ==