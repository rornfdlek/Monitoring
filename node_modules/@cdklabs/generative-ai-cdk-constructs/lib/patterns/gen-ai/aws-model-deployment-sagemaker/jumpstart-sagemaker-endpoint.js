"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.JumpStartSageMakerEndpoint = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const iam = require("aws-cdk-lib/aws-iam");
const sagemaker = require("aws-cdk-lib/aws-sagemaker");
const core_1 = require("aws-cdk-lib/core");
const jumpstart_constants_1 = require("./private/jumpstart-constants");
const sagemaker_endpoint_base_1 = require("./sagemaker-endpoint-base");
const construct_name_enum_1 = require("../../../common/base-class/construct-name-enum");
/**
 * The JumpStartSageMakerEndpoint class.
 */
class JumpStartSageMakerEndpoint extends sagemaker_endpoint_base_1.SageMakerEndpointBase {
    constructor(scope, id, props) {
        super(scope, id);
        const baseProps = {
            constructName: construct_name_enum_1.ConstructName.JUMPSTARTSAGEMAKERENDPOINT,
            constructId: id,
        };
        // No lambda function to use AWS SDK for service metric
        const lambdaFunctions = [];
        this.updateConstructUsageMetricCode(baseProps, scope, lambdaFunctions);
        this.model = props.model;
        this.instanceType = props.instanceType;
        this.instanceCount = Math.max(1, props.instanceCount ?? 1);
        this.acceptEula = props.acceptEula ?? false;
        this.role = props.role ?? this.createSageMakerRole();
        this.grantPrincipal = this.role;
        this.startupHealthCheckTimeoutInSeconds = props.startupHealthCheckTimeoutInSeconds ?? 600;
        this.environment = props.environment;
        this.spec = this.model.bind();
        if (!this.acceptEula && this.spec.requiresEula) {
            throw new Error('The AcceptEula value must be explicitly defined as True in order to accept the EULA for the model ' + this.spec.modelId + '. You are responsible for reviewing and complying with any applicable license terms and making sure they are acceptable for your use case before downloading or using a model.');
        }
        this.region = core_1.Stack.of(this).region;
        if (core_1.Token.isUnresolved(this.region)) {
            throw new Error('Region is unresolved. You should explicitly specify the region in the environment.');
        }
        const instanceType = this.verifyInstanceType();
        const instanseBaseType = instanceType.split('.')[1];
        let model;
        if (this.spec.modelPackageArns) {
            if (this.environment) {
                throw new Error('Environment variables are not supported for model packages.');
            }
            model = this.getModelFromPackage(scope, id, props.vpcConfig);
        }
        else {
            const environment = this.buildEnvironment(instanceType);
            model = this.getModelFromArtifact(scope, id, instanceType, instanseBaseType, environment, props.vpcConfig);
        }
        const endpointConfig = new sagemaker.CfnEndpointConfig(scope, `EndpointConfig-${id}`, {
            productionVariants: [
                {
                    instanceType,
                    initialVariantWeight: 1,
                    initialInstanceCount: this.instanceCount,
                    variantName: 'AllTraffic',
                    modelName: model.getAtt('ModelName').toString(),
                    containerStartupHealthCheckTimeoutInSeconds: this.startupHealthCheckTimeoutInSeconds,
                },
            ],
        });
        endpointConfig.addDependency(model);
        const endpoint = new sagemaker.CfnEndpoint(scope, `${this.spec.modelId}-endpoint-${id}`, {
            endpointConfigName: endpointConfig.getAtt('EndpointConfigName').toString(),
            endpointName: 'jumpstart-' + props.endpointName,
        });
        endpoint.addDependency(endpointConfig);
        this.cfnModel = model;
        this.cfnEndpoint = endpoint;
        this.cfnEndpointConfig = endpointConfig;
        this.endpointArn = endpoint.ref;
    }
    addToRolePolicy(statement) {
        if (!this.role) {
            return;
        }
        this.role.addToPolicy(statement);
    }
    grantInvoke(grantee) {
        return iam.Grant.addToPrincipal({
            grantee,
            actions: ['sagemaker:InvokeEndpoint'],
            resourceArns: [this.endpointArn],
        });
    }
    verifyInstanceType() {
        let instanceType = this.spec.defaultInstanceType;
        if (this.instanceType) {
            instanceType = this.instanceType.toString();
        }
        const supportedInstanceTypes = this.spec.instanceTypes;
        if (!supportedInstanceTypes.includes(instanceType)) {
            throw new Error(`The instance type ${instanceType} is not supported. Default instance type: ${this.spec.defaultInstanceType}. Supported instance types: ${supportedInstanceTypes.join(', ')}.`);
        }
        return instanceType;
    }
    buildEnvironment(instanceType) {
        const configEnvironment = this.spec.instanceVariants?.find((v) => v.instanceType === instanceType)?.environment;
        const environment = {
            ...(this.spec.environment ?? {}),
            ...configEnvironment,
            ...this.environment,
        };
        if (environment.SAGEMAKER_SUBMIT_DIRECTORY) {
            delete environment.SAGEMAKER_SUBMIT_DIRECTORY;
        }
        return environment;
    }
    getModelFromArtifact(scope, id, instanceType, instanceBaseType, environment, vpcConfig) {
        const key = this.spec.prepackedArtifactKey ?? this.spec.artifactKey;
        const bucket = this.spec.gatedBucket ? jumpstart_constants_1.JumpStartConstants.JUMPSTART_LAUNCHED_REGIONS[this.region]?.gatedContentBucket :
            jumpstart_constants_1.JumpStartConstants.JUMPSTART_LAUNCHED_REGIONS[this.region]?.contentBucket;
        if (!bucket) {
            throw new Error(`JumpStart is not available in the region ${this.region}.`);
        }
        const modelArtifactUrl = `s3://${bucket}/${key}`;
        const isArtifactCompressed = modelArtifactUrl.endsWith('.tar.gz');
        const imageUriKey = this.spec.instanceVariants
            ?.find((v) => v.instanceType === instanceBaseType)
            ?.imageUri?.replace('$', '');
        if (!imageUriKey) {
            throw new Error(`The image uri is not available for instance type ${instanceType}.`);
        }
        const image = this.spec.instanceAliases?.find((v) => v.region === this.region)?.aliases[imageUriKey];
        if (!image) {
            throw new Error(`The image uri is not available for instance type ${instanceType} in region ${this.region}.`);
        }
        const model = new sagemaker.CfnModel(scope, `${this.spec.modelId}-model-${id}`, {
            executionRoleArn: this.role.roleArn,
            enableNetworkIsolation: true,
            primaryContainer: isArtifactCompressed ? {
                // True: Artifact is a tarball
                image,
                modelDataUrl: modelArtifactUrl,
                environment,
            } : {
                // False: Model is uncompressed
                image,
                modelDataSource: {
                    s3DataSource: {
                        compressionType: 'None',
                        s3DataType: 'S3Prefix',
                        s3Uri: modelArtifactUrl,
                        modelAccessConfig: {
                            acceptEula: this.acceptEula,
                        },
                    },
                },
                environment,
            },
            tags: [
                {
                    key: 'modelId',
                    value: this.spec.modelId,
                },
                {
                    key: 'modelVersion',
                    value: this.spec.version,
                },
                {
                    key: 'sagemaker-studio:jumpstart-model-id',
                    value: this.spec.modelId,
                },
                {
                    key: 'sagemaker-studio:jumpstart-model-version',
                    value: this.spec.version,
                },
                {
                    key: 'sagemaker-studio:jumpstart-hub-name',
                    value: 'SageMakerPublicHub',
                },
            ],
            vpcConfig: vpcConfig,
        });
        return model;
    }
    getModelFromPackage(scope, id, vpcConfig) {
        const modelPackageArns = this.spec.modelPackageArns || {};
        const supportedRegions = Object.keys(modelPackageArns);
        if (!supportedRegions.includes(this.region)) {
            throw new Error(`The model package is not available in the region ${this.region}. Supported regions: ${supportedRegions.join(', ')}.`);
        }
        const modelPackageArn = modelPackageArns[this.region];
        const model = new sagemaker.CfnModel(scope, `${this.spec.modelId}-model-${id}`, {
            executionRoleArn: this.role.roleArn,
            enableNetworkIsolation: true,
            primaryContainer: {
                modelPackageName: modelPackageArn,
            },
            tags: [
                {
                    key: 'modelId',
                    value: this.spec.modelId,
                },
                {
                    key: 'modelVersion',
                    value: this.spec.version,
                },
            ],
            vpcConfig: vpcConfig,
        });
        return model;
    }
}
exports.JumpStartSageMakerEndpoint = JumpStartSageMakerEndpoint;
_a = JSII_RTTI_SYMBOL_1;
JumpStartSageMakerEndpoint[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.JumpStartSageMakerEndpoint", version: "0.1.285" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianVtcHN0YXJ0LXNhZ2VtYWtlci1lbmRwb2ludC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9wYXR0ZXJucy9nZW4tYWkvYXdzLW1vZGVsLWRlcGxveW1lbnQtc2FnZW1ha2VyL2p1bXBzdGFydC1zYWdlbWFrZXItZW5kcG9pbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFhQSwyQ0FBMkM7QUFDM0MsdURBQXVEO0FBQ3ZELDJDQUFnRDtBQUdoRCx1RUFBbUU7QUFDbkUsdUVBQWtFO0FBR2xFLHdGQUErRTtBQWUvRTs7R0FFRztBQUNILE1BQWEsMEJBQTJCLFNBQVEsK0NBQXFCO0lBa0JuRSxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXNDO1FBQzlFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxTQUFTLEdBQW1CO1lBQ2hDLGFBQWEsRUFBRSxtQ0FBYSxDQUFDLDBCQUEwQjtZQUN2RCxXQUFXLEVBQUUsRUFBRTtTQUNoQixDQUFDO1FBRUYsdURBQXVEO1FBQ3ZELE1BQU0sZUFBZSxHQUF5QyxFQUFFLENBQUM7UUFDakUsSUFBSSxDQUFDLDhCQUE4QixDQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFHeEUsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQztRQUN2QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxhQUFhLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQztRQUU1QyxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLG1CQUFt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QUUsQ0FBQztZQUM1QyxNQUFNLElBQUksS0FBSyxDQUNiLG9EQUNFLElBQUksQ0FBQyxNQUNQLHdCQUF3QixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FDdkQsQ0FBQztRQUNKLENBQUM7UUFFRCxNQUFNLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFdEQsTUFBTSxLQUFLLEdBQUcsSUFBSSxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxVQUFVLEVBQUUsRUFBRSxFQUFFO1lBQzlFLGdCQUFnQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTztZQUNuQyxzQkFBc0IsRUFBRSxJQUFJO1lBQzVCLGdCQUFnQixFQUFFO2dCQUNoQixnQkFBZ0IsRUFBRSxlQUFlO2FBQ2xDO1lBQ0QsSUFBSSxFQUFFO2dCQUNKO29CQUNFLEdBQUcsRUFBRSxTQUFTO29CQUNkLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87aUJBQ3pCO2dCQUNEO29CQUNFLEdBQUcsRUFBRSxjQUFjO29CQUNuQixLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPO2lCQUN6QjthQUNGO1lBQ0QsU0FBUyxFQUFFLFNBQVM7U0FDckIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOztBQS9RSCxnRUFnUkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCAqIGFzIHNhZ2VtYWtlciBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2FnZW1ha2VyJztcbmltcG9ydCB7IFN0YWNrLCBUb2tlbiB9IGZyb20gJ2F3cy1jZGstbGliL2NvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBKdW1wU3RhcnRNb2RlbCwgSUp1bXBTdGFydE1vZGVsU3BlYyB9IGZyb20gJy4vanVtcHN0YXJ0LW1vZGVsJztcbmltcG9ydCB7IEp1bXBTdGFydENvbnN0YW50cyB9IGZyb20gJy4vcHJpdmF0ZS9qdW1wc3RhcnQtY29uc3RhbnRzJztcbmltcG9ydCB7IFNhZ2VNYWtlckVuZHBvaW50QmFzZSB9IGZyb20gJy4vc2FnZW1ha2VyLWVuZHBvaW50LWJhc2UnO1xuaW1wb3J0IHsgU2FnZU1ha2VySW5zdGFuY2VUeXBlIH0gZnJvbSAnLi9zYWdlbWFrZXItaW5zdGFuY2UtdHlwZSc7XG5pbXBvcnQgeyBCYXNlQ2xhc3NQcm9wcyB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9iYXNlLWNsYXNzL2Jhc2UtY2xhc3MnO1xuaW1wb3J0IHsgQ29uc3RydWN0TmFtZSB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9iYXNlLWNsYXNzL2NvbnN0cnVjdC1uYW1lLWVudW0nO1xuXG5leHBvcnQgaW50ZXJmYWNlIEp1bXBTdGFydFNhZ2VNYWtlckVuZHBvaW50UHJvcHMge1xuICByZWFkb25seSBtb2RlbDogSnVtcFN0YXJ0TW9kZWw7XG4gIHJlYWRvbmx5IGVuZHBvaW50TmFtZTogc3RyaW5nO1xuICByZWFkb25seSBpbnN0YW5jZVR5cGU/OiBTYWdlTWFrZXJJbnN0YW5jZVR5cGU7XG4gIHJlYWRvbmx5IGluc3RhbmNlQ291bnQ/OiBudW1iZXI7XG4gIHJlYWRvbmx5IHJvbGU/OiBpYW0uUm9sZTtcbiAgcmVhZG9ubHkgdnBjQ29uZmlnPzogc2FnZW1ha2VyLkNmbk1vZGVsLlZwY0NvbmZpZ1Byb3BlcnR5IHwgdW5kZWZpbmVkO1xuICByZWFkb25seSBlbnZpcm9ubWVudD86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gIHJlYWRvbmx5IHN0YXJ0dXBIZWFsdGhDaGVja1RpbWVvdXRJblNlY29uZHM/OiBudW1iZXI7XG4gIHJlYWRvbmx5IGFjY2VwdEV1bGE/OiBib29sZWFuO1xuXG59XG5cbi8qKlxuICogVGhlIEp1bXBTdGFydFNhZ2VNYWtlckVuZHBvaW50IGNsYXNzLlxuICovXG5leHBvcnQgY2xhc3MgSnVtcFN0YXJ0U2FnZU1ha2VyRW5kcG9pbnQgZXh0ZW5kcyBTYWdlTWFrZXJFbmRwb2ludEJhc2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgZ3JhbnRQcmluY2lwYWw6IGlhbS5JUHJpbmNpcGFsO1xuICBwdWJsaWMgcmVhZG9ubHkgZW5kcG9pbnRBcm46IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGNmbk1vZGVsOiBzYWdlbWFrZXIuQ2ZuTW9kZWw7XG4gIHB1YmxpYyByZWFkb25seSBjZm5FbmRwb2ludDogc2FnZW1ha2VyLkNmbkVuZHBvaW50O1xuICBwdWJsaWMgcmVhZG9ubHkgY2ZuRW5kcG9pbnRDb25maWc6IHNhZ2VtYWtlci5DZm5FbmRwb2ludENvbmZpZztcblxuICBwdWJsaWMgcmVhZG9ubHkgbW9kZWw6IEp1bXBTdGFydE1vZGVsO1xuICBwdWJsaWMgcmVhZG9ubHkgaW5zdGFuY2VUeXBlPzogU2FnZU1ha2VySW5zdGFuY2VUeXBlO1xuICBwdWJsaWMgcmVhZG9ubHkgaW5zdGFuY2VDb3VudDogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgcm9sZTogaWFtLlJvbGU7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBhY2NlcHRFdWxhOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZ2lvbjogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHNwZWM6IElKdW1wU3RhcnRNb2RlbFNwZWM7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RhcnR1cEhlYWx0aENoZWNrVGltZW91dEluU2Vjb25kczogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGVudmlyb25tZW50PzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogSnVtcFN0YXJ0U2FnZU1ha2VyRW5kcG9pbnRQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBiYXNlUHJvcHM6IEJhc2VDbGFzc1Byb3BzID0ge1xuICAgICAgY29uc3RydWN0TmFtZTogQ29uc3RydWN0TmFtZS5KVU1QU1RBUlRTQUdFTUFLRVJFTkRQT0lOVCxcbiAgICAgIGNvbnN0cnVjdElkOiBpZCxcbiAgICB9O1xuXG4gICAgLy8gTm8gbGFtYmRhIGZ1bmN0aW9uIHRvIHVzZSBBV1MgU0RLIGZvciBzZXJ2aWNlIG1ldHJpY1xuICAgIGNvbnN0IGxhbWJkYUZ1bmN0aW9uczogY2RrLmF3c19sYW1iZGEuRG9ja2VySW1hZ2VGdW5jdGlvbltdID0gW107XG4gICAgdGhpcy51cGRhdGVDb25zdHJ1Y3RVc2FnZU1ldHJpY0NvZGUoIGJhc2VQcm9wcywgc2NvcGUsIGxhbWJkYUZ1bmN0aW9ucyk7XG5cblxuICAgIHRoaXMubW9kZWwgPSBwcm9wcy5tb2RlbDtcbiAgICB0aGlzLmluc3RhbmNlVHlwZSA9IHByb3BzLmluc3RhbmNlVHlwZTtcbiAgICB0aGlzLmluc3RhbmNlQ291bnQgPSBNYXRoLm1heCgxLCBwcm9wcy5pbnN0YW5jZUNvdW50ID8/IDEpO1xuICAgIHRoaXMuYWNjZXB0RXVsYSA9IHByb3BzLmFjY2VwdEV1bGEgPz8gZmFsc2U7XG5cbiAgICB0aGlzLnJvbGUgPSBwcm9wcy5yb2xlID8/IHRoaXMuY3JlYXRlU2FnZU1ha2VyUm9sZSgpO1xuICAgIHRoaXMuZ3JhbnRQcmluY2lwYWwgPSB0aGlzLnJvbGU7XG5cbiAgICB0aGlzLnN0YXJ0dXBIZWFsdGhDaGVja1RpbWVvdXRJblNlY29uZHMgPSBwcm9wcy5zdGFydHVwSGVhbHRoQ2hlY2tUaW1lb3V0SW5TZWNvbmRzID8/IDYwMDtcbiAgICB0aGlzLmVudmlyb25tZW50ID0gcHJvcHMuZW52aXJvbm1lbnQ7XG4gICAgdGhpcy5zcGVjID0gdGhpcy5tb2RlbC5iaW5kKCk7XG5cbiAgICBpZiAoIXRoaXMuYWNjZXB0RXVsYSAmJiB0aGlzLnNwZWMucmVxdWlyZXNFdWxhKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgQWNjZXB0RXVsYSB2YWx1ZSBtdXN0IGJlIGV4cGxpY2l0bHkgZGVmaW5lZCBhcyBUcnVlIGluIG9yZGVyIHRvIGFjY2VwdCB0aGUgRVVMQSBmb3IgdGhlIG1vZGVsICcgKyB0aGlzLnNwZWMubW9kZWxJZCArICcuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHJldmlld2luZyBhbmQgY29tcGx5aW5nIHdpdGggYW55IGFwcGxpY2FibGUgbGljZW5zZSB0ZXJtcyBhbmQgbWFraW5nIHN1cmUgdGhleSBhcmUgYWNjZXB0YWJsZSBmb3IgeW91ciB1c2UgY2FzZSBiZWZvcmUgZG93bmxvYWRpbmcgb3IgdXNpbmcgYSBtb2RlbC4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLnJlZ2lvbiA9IFN0YWNrLm9mKHRoaXMpLnJlZ2lvbjtcblxuICAgIGlmIChUb2tlbi5pc1VucmVzb2x2ZWQodGhpcy5yZWdpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdSZWdpb24gaXMgdW5yZXNvbHZlZC4gWW91IHNob3VsZCBleHBsaWNpdGx5IHNwZWNpZnkgdGhlIHJlZ2lvbiBpbiB0aGUgZW52aXJvbm1lbnQuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgaW5zdGFuY2VUeXBlID0gdGhpcy52ZXJpZnlJbnN0YW5jZVR5cGUoKTtcbiAgICBjb25zdCBpbnN0YW5zZUJhc2VUeXBlID0gaW5zdGFuY2VUeXBlLnNwbGl0KCcuJylbMV07XG5cbiAgICBsZXQgbW9kZWw6IHNhZ2VtYWtlci5DZm5Nb2RlbDtcbiAgICBpZiAodGhpcy5zcGVjLm1vZGVsUGFja2FnZUFybnMpIHtcbiAgICAgIGlmICh0aGlzLmVudmlyb25tZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBub3Qgc3VwcG9ydGVkIGZvciBtb2RlbCBwYWNrYWdlcy4nKTtcbiAgICAgIH1cblxuICAgICAgbW9kZWwgPSB0aGlzLmdldE1vZGVsRnJvbVBhY2thZ2Uoc2NvcGUsIGlkLCBwcm9wcy52cGNDb25maWcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBlbnZpcm9ubWVudCA9IHRoaXMuYnVpbGRFbnZpcm9ubWVudChpbnN0YW5jZVR5cGUpO1xuICAgICAgbW9kZWwgPSB0aGlzLmdldE1vZGVsRnJvbUFydGlmYWN0KHNjb3BlLCBpZCwgaW5zdGFuY2VUeXBlLCBpbnN0YW5zZUJhc2VUeXBlLCBlbnZpcm9ubWVudCwgcHJvcHMudnBjQ29uZmlnKTtcbiAgICB9XG5cbiAgICBjb25zdCBlbmRwb2ludENvbmZpZyA9IG5ldyBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnRDb25maWcoc2NvcGUsIGBFbmRwb2ludENvbmZpZy0ke2lkfWAsIHtcbiAgICAgIHByb2R1Y3Rpb25WYXJpYW50czogW1xuICAgICAgICB7XG4gICAgICAgICAgaW5zdGFuY2VUeXBlLFxuICAgICAgICAgIGluaXRpYWxWYXJpYW50V2VpZ2h0OiAxLFxuICAgICAgICAgIGluaXRpYWxJbnN0YW5jZUNvdW50OiB0aGlzLmluc3RhbmNlQ291bnQsXG4gICAgICAgICAgdmFyaWFudE5hbWU6ICdBbGxUcmFmZmljJyxcbiAgICAgICAgICBtb2RlbE5hbWU6IG1vZGVsLmdldEF0dCgnTW9kZWxOYW1lJykudG9TdHJpbmcoKSxcbiAgICAgICAgICBjb250YWluZXJTdGFydHVwSGVhbHRoQ2hlY2tUaW1lb3V0SW5TZWNvbmRzOiB0aGlzLnN0YXJ0dXBIZWFsdGhDaGVja1RpbWVvdXRJblNlY29uZHMsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgZW5kcG9pbnRDb25maWcuYWRkRGVwZW5kZW5jeShtb2RlbCk7XG5cbiAgICBjb25zdCBlbmRwb2ludCA9IG5ldyBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnQoc2NvcGUsIGAke3RoaXMuc3BlYy5tb2RlbElkfS1lbmRwb2ludC0ke2lkfWAsIHtcbiAgICAgIGVuZHBvaW50Q29uZmlnTmFtZTogZW5kcG9pbnRDb25maWcuZ2V0QXR0KCdFbmRwb2ludENvbmZpZ05hbWUnKS50b1N0cmluZygpLFxuICAgICAgZW5kcG9pbnROYW1lOiAnanVtcHN0YXJ0LScgKyBwcm9wcy5lbmRwb2ludE5hbWUsXG4gICAgfSk7XG5cbiAgICBlbmRwb2ludC5hZGREZXBlbmRlbmN5KGVuZHBvaW50Q29uZmlnKTtcblxuICAgIHRoaXMuY2ZuTW9kZWwgPSBtb2RlbDtcbiAgICB0aGlzLmNmbkVuZHBvaW50ID0gZW5kcG9pbnQ7XG4gICAgdGhpcy5jZm5FbmRwb2ludENvbmZpZyA9IGVuZHBvaW50Q29uZmlnO1xuICAgIHRoaXMuZW5kcG9pbnRBcm4gPSBlbmRwb2ludC5yZWY7XG4gIH1cblxuICBwdWJsaWMgYWRkVG9Sb2xlUG9saWN5KHN0YXRlbWVudDogaWFtLlBvbGljeVN0YXRlbWVudCkge1xuICAgIGlmICghdGhpcy5yb2xlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5yb2xlLmFkZFRvUG9saWN5KHN0YXRlbWVudCk7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRJbnZva2UoZ3JhbnRlZTogaWFtLklHcmFudGFibGUpOiBpYW0uR3JhbnQge1xuICAgIHJldHVybiBpYW0uR3JhbnQuYWRkVG9QcmluY2lwYWwoe1xuICAgICAgZ3JhbnRlZSxcbiAgICAgIGFjdGlvbnM6IFsnc2FnZW1ha2VyOkludm9rZUVuZHBvaW50J10sXG4gICAgICByZXNvdXJjZUFybnM6IFt0aGlzLmVuZHBvaW50QXJuXSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdmVyaWZ5SW5zdGFuY2VUeXBlKCkge1xuICAgIGxldCBpbnN0YW5jZVR5cGUgPSB0aGlzLnNwZWMuZGVmYXVsdEluc3RhbmNlVHlwZTtcbiAgICBpZiAodGhpcy5pbnN0YW5jZVR5cGUpIHtcbiAgICAgIGluc3RhbmNlVHlwZSA9IHRoaXMuaW5zdGFuY2VUeXBlLnRvU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VwcG9ydGVkSW5zdGFuY2VUeXBlcyA9IHRoaXMuc3BlYy5pbnN0YW5jZVR5cGVzO1xuICAgIGlmICghc3VwcG9ydGVkSW5zdGFuY2VUeXBlcy5pbmNsdWRlcyhpbnN0YW5jZVR5cGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgaW5zdGFuY2UgdHlwZSAke2luc3RhbmNlVHlwZX0gaXMgbm90IHN1cHBvcnRlZC4gRGVmYXVsdCBpbnN0YW5jZSB0eXBlOiAke1xuICAgICAgICAgIHRoaXMuc3BlYy5kZWZhdWx0SW5zdGFuY2VUeXBlXG4gICAgICAgIH0uIFN1cHBvcnRlZCBpbnN0YW5jZSB0eXBlczogJHtzdXBwb3J0ZWRJbnN0YW5jZVR5cGVzLmpvaW4oJywgJyl9LmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBpbnN0YW5jZVR5cGU7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRW52aXJvbm1lbnQoaW5zdGFuY2VUeXBlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjb25maWdFbnZpcm9ubWVudCA9IHRoaXMuc3BlYy5pbnN0YW5jZVZhcmlhbnRzPy5maW5kKFxuICAgICAgKHYpID0+IHYuaW5zdGFuY2VUeXBlID09PSBpbnN0YW5jZVR5cGUsXG4gICAgKT8uZW52aXJvbm1lbnQ7XG5cbiAgICBjb25zdCBlbnZpcm9ubWVudCA9IHtcbiAgICAgIC4uLih0aGlzLnNwZWMuZW52aXJvbm1lbnQgPz8ge30pLFxuICAgICAgLi4uY29uZmlnRW52aXJvbm1lbnQsXG4gICAgICAuLi50aGlzLmVudmlyb25tZW50LFxuICAgIH07XG5cbiAgICBpZiAoZW52aXJvbm1lbnQuU0FHRU1BS0VSX1NVQk1JVF9ESVJFQ1RPUlkpIHtcbiAgICAgIGRlbGV0ZSBlbnZpcm9ubWVudC5TQUdFTUFLRVJfU1VCTUlUX0RJUkVDVE9SWTtcbiAgICB9XG5cbiAgICByZXR1cm4gZW52aXJvbm1lbnQ7XG4gIH1cblxuICBwcml2YXRlIGdldE1vZGVsRnJvbUFydGlmYWN0KFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBpbnN0YW5jZVR5cGU6IHN0cmluZyxcbiAgICBpbnN0YW5jZUJhc2VUeXBlOiBzdHJpbmcsXG4gICAgZW52aXJvbm1lbnQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB9LFxuICAgIHZwY0NvbmZpZzogc2FnZW1ha2VyLkNmbk1vZGVsLlZwY0NvbmZpZ1Byb3BlcnR5IHwgdW5kZWZpbmVkLFxuICApIHtcbiAgICBjb25zdCBrZXkgPSB0aGlzLnNwZWMucHJlcGFja2VkQXJ0aWZhY3RLZXkgPz8gdGhpcy5zcGVjLmFydGlmYWN0S2V5O1xuICAgIGNvbnN0IGJ1Y2tldCA9IHRoaXMuc3BlYy5nYXRlZEJ1Y2tldCA/IEp1bXBTdGFydENvbnN0YW50cy5KVU1QU1RBUlRfTEFVTkNIRURfUkVHSU9OU1t0aGlzLnJlZ2lvbl0/LmdhdGVkQ29udGVudEJ1Y2tldCA6XG4gICAgICBKdW1wU3RhcnRDb25zdGFudHMuSlVNUFNUQVJUX0xBVU5DSEVEX1JFR0lPTlNbdGhpcy5yZWdpb25dPy5jb250ZW50QnVja2V0O1xuICAgIGlmICghYnVja2V0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEp1bXBTdGFydCBpcyBub3QgYXZhaWxhYmxlIGluIHRoZSByZWdpb24gJHt0aGlzLnJlZ2lvbn0uYCk7XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZWxBcnRpZmFjdFVybCA9IGBzMzovLyR7YnVja2V0fS8ke2tleX1gO1xuICAgIGNvbnN0IGlzQXJ0aWZhY3RDb21wcmVzc2VkID0gbW9kZWxBcnRpZmFjdFVybC5lbmRzV2l0aCgnLnRhci5neicpO1xuXG4gICAgY29uc3QgaW1hZ2VVcmlLZXkgPSB0aGlzLnNwZWMuaW5zdGFuY2VWYXJpYW50c1xuICAgICAgPy5maW5kKCh2KSA9PiB2Lmluc3RhbmNlVHlwZSA9PT0gaW5zdGFuY2VCYXNlVHlwZSlcbiAgICAgID8uaW1hZ2VVcmk/LnJlcGxhY2UoJyQnLCAnJyk7XG5cbiAgICBpZiAoIWltYWdlVXJpS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBpbWFnZSB1cmkgaXMgbm90IGF2YWlsYWJsZSBmb3IgaW5zdGFuY2UgdHlwZSAke2luc3RhbmNlVHlwZX0uYCk7XG4gICAgfVxuXG4gICAgY29uc3QgaW1hZ2UgPSB0aGlzLnNwZWMuaW5zdGFuY2VBbGlhc2VzPy5maW5kKCh2KSA9PiB2LnJlZ2lvbiA9PT0gdGhpcy5yZWdpb24pPy5hbGlhc2VzW1xuICAgICAgaW1hZ2VVcmlLZXlcbiAgICBdO1xuICAgIGlmICghaW1hZ2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBpbWFnZSB1cmkgaXMgbm90IGF2YWlsYWJsZSBmb3IgaW5zdGFuY2UgdHlwZSAke2luc3RhbmNlVHlwZX0gaW4gcmVnaW9uICR7dGhpcy5yZWdpb259LmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsID0gbmV3IHNhZ2VtYWtlci5DZm5Nb2RlbChzY29wZSwgYCR7dGhpcy5zcGVjLm1vZGVsSWR9LW1vZGVsLSR7aWR9YCwge1xuICAgICAgZXhlY3V0aW9uUm9sZUFybjogdGhpcy5yb2xlLnJvbGVBcm4sXG4gICAgICBlbmFibGVOZXR3b3JrSXNvbGF0aW9uOiB0cnVlLFxuICAgICAgcHJpbWFyeUNvbnRhaW5lcjogaXNBcnRpZmFjdENvbXByZXNzZWQgPyB7XG4gICAgICAgIC8vIFRydWU6IEFydGlmYWN0IGlzIGEgdGFyYmFsbFxuICAgICAgICBpbWFnZSxcbiAgICAgICAgbW9kZWxEYXRhVXJsOiBtb2RlbEFydGlmYWN0VXJsLFxuICAgICAgICBlbnZpcm9ubWVudCxcbiAgICAgIH0gOiB7XG4gICAgICAgIC8vIEZhbHNlOiBNb2RlbCBpcyB1bmNvbXByZXNzZWRcbiAgICAgICAgaW1hZ2UsXG4gICAgICAgIG1vZGVsRGF0YVNvdXJjZToge1xuICAgICAgICAgIHMzRGF0YVNvdXJjZToge1xuICAgICAgICAgICAgY29tcHJlc3Npb25UeXBlOiAnTm9uZScsXG4gICAgICAgICAgICBzM0RhdGFUeXBlOiAnUzNQcmVmaXgnLFxuICAgICAgICAgICAgczNVcmk6IG1vZGVsQXJ0aWZhY3RVcmwsXG4gICAgICAgICAgICBtb2RlbEFjY2Vzc0NvbmZpZzoge1xuICAgICAgICAgICAgICBhY2NlcHRFdWxhOiB0aGlzLmFjY2VwdEV1bGEsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGVudmlyb25tZW50LFxuICAgICAgfSxcbiAgICAgIHRhZ3M6IFtcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ21vZGVsSWQnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLnNwZWMubW9kZWxJZCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ21vZGVsVmVyc2lvbicsXG4gICAgICAgICAgdmFsdWU6IHRoaXMuc3BlYy52ZXJzaW9uLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAga2V5OiAnc2FnZW1ha2VyLXN0dWRpbzpqdW1wc3RhcnQtbW9kZWwtaWQnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLnNwZWMubW9kZWxJZCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ3NhZ2VtYWtlci1zdHVkaW86anVtcHN0YXJ0LW1vZGVsLXZlcnNpb24nLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLnNwZWMudmVyc2lvbixcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ3NhZ2VtYWtlci1zdHVkaW86anVtcHN0YXJ0LWh1Yi1uYW1lJyxcbiAgICAgICAgICB2YWx1ZTogJ1NhZ2VNYWtlclB1YmxpY0h1YicsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgdnBjQ29uZmlnOiB2cGNDb25maWcsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gbW9kZWw7XG4gIH1cblxuICBwcml2YXRlIGdldE1vZGVsRnJvbVBhY2thZ2Uoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgdnBjQ29uZmlnOiBzYWdlbWFrZXIuQ2ZuTW9kZWwuVnBjQ29uZmlnUHJvcGVydHkgfCB1bmRlZmluZWQpIHtcbiAgICBjb25zdCBtb2RlbFBhY2thZ2VBcm5zID0gdGhpcy5zcGVjLm1vZGVsUGFja2FnZUFybnMgfHwge307XG4gICAgY29uc3Qgc3VwcG9ydGVkUmVnaW9ucyA9IE9iamVjdC5rZXlzKG1vZGVsUGFja2FnZUFybnMpO1xuICAgIGlmICghc3VwcG9ydGVkUmVnaW9ucy5pbmNsdWRlcyh0aGlzLnJlZ2lvbikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBtb2RlbCBwYWNrYWdlIGlzIG5vdCBhdmFpbGFibGUgaW4gdGhlIHJlZ2lvbiAke1xuICAgICAgICAgIHRoaXMucmVnaW9uXG4gICAgICAgIH0uIFN1cHBvcnRlZCByZWdpb25zOiAke3N1cHBvcnRlZFJlZ2lvbnMuam9pbignLCAnKX0uYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZWxQYWNrYWdlQXJuID0gbW9kZWxQYWNrYWdlQXJuc1t0aGlzLnJlZ2lvbl07XG5cbiAgICBjb25zdCBtb2RlbCA9IG5ldyBzYWdlbWFrZXIuQ2ZuTW9kZWwoc2NvcGUsIGAke3RoaXMuc3BlYy5tb2RlbElkfS1tb2RlbC0ke2lkfWAsIHtcbiAgICAgIGV4ZWN1dGlvblJvbGVBcm46IHRoaXMucm9sZS5yb2xlQXJuLFxuICAgICAgZW5hYmxlTmV0d29ya0lzb2xhdGlvbjogdHJ1ZSxcbiAgICAgIHByaW1hcnlDb250YWluZXI6IHtcbiAgICAgICAgbW9kZWxQYWNrYWdlTmFtZTogbW9kZWxQYWNrYWdlQXJuLFxuICAgICAgfSxcbiAgICAgIHRhZ3M6IFtcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ21vZGVsSWQnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLnNwZWMubW9kZWxJZCxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGtleTogJ21vZGVsVmVyc2lvbicsXG4gICAgICAgICAgdmFsdWU6IHRoaXMuc3BlYy52ZXJzaW9uLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIHZwY0NvbmZpZzogdnBjQ29uZmlnLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1vZGVsO1xuICB9XG59XG4iXX0=